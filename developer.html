<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>RW API Developer docs</title>

    <style>
      .highlight table td { padding: 5px; }
.highlight table pre { margin: 0; }
.highlight, .highlight .w {
  color: #f8f8f2;
  background-color: #272822;
}
.highlight .err {
  color: #272822;
  background-color: #f92672;
}
.highlight .c, .highlight .cd, .highlight .cm, .highlight .c1, .highlight .cs {
  color: #75715e;
}
.highlight .cp {
  color: #f4bf75;
}
.highlight .nt {
  color: #f4bf75;
}
.highlight .o, .highlight .ow {
  color: #f8f8f2;
}
.highlight .p, .highlight .pi {
  color: #f8f8f2;
}
.highlight .gi {
  color: #a6e22e;
}
.highlight .gd {
  color: #f92672;
}
.highlight .gh {
  color: #66d9ef;
  background-color: #272822;
  font-weight: bold;
}
.highlight .k, .highlight .kn, .highlight .kp, .highlight .kr, .highlight .kv {
  color: #ae81ff;
}
.highlight .kc {
  color: #fd971f;
}
.highlight .kt {
  color: #fd971f;
}
.highlight .kd {
  color: #fd971f;
}
.highlight .s, .highlight .sb, .highlight .sc, .highlight .sd, .highlight .s2, .highlight .sh, .highlight .sx, .highlight .s1 {
  color: #a6e22e;
}
.highlight .sr {
  color: #a1efe4;
}
.highlight .si {
  color: #cc6633;
}
.highlight .se {
  color: #cc6633;
}
.highlight .nn {
  color: #f4bf75;
}
.highlight .nc {
  color: #f4bf75;
}
.highlight .no {
  color: #f4bf75;
}
.highlight .na {
  color: #66d9ef;
}
.highlight .m, .highlight .mf, .highlight .mh, .highlight .mi, .highlight .il, .highlight .mo, .highlight .mb, .highlight .mx {
  color: #a6e22e;
}
.highlight .ss {
  color: #a6e22e;
}
    </style>
    <link href="stylesheets/screen.css" rel="stylesheet" media="screen" />
    <link href="stylesheets/print.css" rel="stylesheet" media="print" />
      <script src="javascripts/all.js"></script>
  </head>

  <body class="developer rw" data-languages="[&quot;shell&quot;]">
    <a href="#" id="nav-button">
      <span>
        NAV
        <img src="images/navbar.png" alt="Navbar" />
      </span>
    </a>
    <div class="tocify-wrapper">
      <img src="images/logo-rw.png" alt="Logo rw" />
        <div class="lang-selector">
              <a href="#" data-language-name="shell">cURL</a>
        </div>
        <div class="search">
          <input type="text" class="search" id="input-search" placeholder="Search">
        </div>
        <ul class="search-results"></ul>
      <div id="toc">
      </div>
        <ul class="toc-footer">
            <li><a href='https://ui.resourcewatch.org'>Sign Up for a Developer Key</a></li>
            <li><a href='https://github.com/resource-watch/doc-api'>Contribute to these docs</a></li>
            <li><a href='https://github.com/tripit/slate'>Documentation Powered by Slate</a></li>
        </ul>
    </div>
    <div class="page-wrapper">
      <div class="dark-box"></div>
      <div class="content">
        
          <h1 id="introduction">Introduction</h1>

<p>Welcome to the Resource Watch API Developer Documentation. </p>

<h2 id="who-is-this-for">Who is this for?</h2>

<p>This section covers the behind-the-scenes details of the RW API, that are relevant for developers trying to build their own RW API microservice. If you are looking for instructions on how to use the RW API to power your applications, the <a href="/">RW API Documentation</a> is probably what you are looking for.</p>

<p>The developer documentation is aimed at software developers that are familiar with the RW API from a user perspective, and want to extend or modify the functionality of the API. From a technical point of view, this section assumes you are familiar with some technologies, protocols and patterns that are used on the RW API, such as:</p>

<ul>
<li><a href="https://en.wikipedia.org/wiki/Hypertext_Transfer_Protocol">HTTP and HTTPS</a></li>
<li><a href="https://en.wikipedia.org/wiki/Microservices">Microservices architecture</a></li>
<li><a href="https://www.docker.com/">Docker</a></li>
<li><a href="https://kubernetes.io/">Kubernetes</a></li>
</ul>

<p>This guide also assumes you are comfortable with programming in general. To keep these docs simple, and as most of the RW API source code is written in <a href="https://nodejs.org/en/">nodejs</a>, that is the language we&rsquo;ll use for examples or when presenting specific tools and libraries. However, while we recommend using Nodejs, you may use different tools and/or languages when developing your microservices.  </p>

<p>If any of these concepts are new or unfamiliar, we suggest using your favourite search engine to learn more about them before proceeding.</p>

          <h1 id="api-architecture">API Architecture</h1>

<p>This chapter covers the basic architectural details of the API. If you are new to RW API development, you should start here, as key concepts explained here will be needed as you go more hands-on with the API code and/or infrastructure.</p>

<h2 id="microservice-architecture">Microservice architecture</h2>

<p>The RW API is built using a <a href="https://en.wikipedia.org/wiki/Microservices">microservices architecture</a> using <a href="https://github.com/control-tower/control-tower">Control Tower</a> as the gateway application.</p>

<p>In this configuration, Control Tower (CT) offers gateway and core functionality, like routing or user management, while user-facing functionality is provided by a set of microservices that communicate with each other and the external world through Control Tower.</p>

<p>Internal communication between CT and the microservices is done through HTTP requests, and as such each microservice is built on top of a web server..These different web servers create a network within the API itself, to which will refer throughout the rest of the documentation when we mention &ldquo;internal network&rdquo; or &ldquo;internal requests&rdquo;. By opposition, an &ldquo;external request&rdquo; will reference a request from/to the world wide web, and &ldquo;external network&rdquo; basically means &ldquo;the internet&rdquo;.</p>

<p>Control Tower itself acts both as an API in itself - with endpoints for management and monitoring - as well as a catch-all side, that is used to proxy requests to the functional endpoints.</p>

<h2 id="microservice-dependency-graphs">Microservice dependency graphs</h2>

<p><img src="https://raw.githubusercontent.com/gfw-api/wri-api-dependencies/master/graphs/dependencies_graph.png" alt="Microservice dependency graph" /></p>

<p>The graph above illustrates the dependencies between different microservices as of July 2020. Most dependencies are based on endpoint calls: an arrow pointing from <code class="prettyprint">query</code> to <code class="prettyprint">dataset</code> means that the <code class="prettyprint">query</code> microservice makes a call to one of the endpoints implemented by the <code class="prettyprint">dataset</code> microservice. The exception to this rule are <code class="prettyprint">doc-orchestrator</code>,  <code class="prettyprint">doc-executor</code> and  <code class="prettyprint">doc-writer</code>, who instead depend on each other via <a href="https://www.rabbitmq.com/">RabbitMQ</a> messages.</p>

<p><img src="https://raw.githubusercontent.com/gfw-api/wri-api-dependencies/master/graphs/no_dependencies_graph.png" alt="Microservice with no dependencies" /></p>

<p>The microservices above do not depend on any of the other microservices.</p>

<p>It&rsquo;s worth noting that most microservices depend on Control Tower and functionality implicitly offered by it - for example, Control Tower will automatically pass to the microservice the details of the user, should the original HTTP request come with a valid JWT token.</p>

<h2 id="data-layer-dependencies">Data layer dependencies</h2>

<p><img src="https://raw.githubusercontent.com/gfw-api/wri-api-dependencies/master/graphs/storage_graph.png" alt="Data layer dependencies" /></p>

<p>The graph above illustrates the different data layer elements present on the RW API, and the microservices or sites that depend on each of these.</p>

<h2 id="lifecycle-of-a-request">Lifecycle of a request</h2>

<p>All incoming requests to the API are handled by CT that, among other things, does the following:
- Checks if there&rsquo;s a microservice capable of handling that request.
- Checks if authentication data is required and/or is present.
- Automatically filters out anonymous requests to authenticated endpoints.</p>

<p>We&rsquo;ll go into more details about these processes in the next sections</p>

<p>Control Tower matches each incoming external request to a microservice, by comparing its URI and request method. It then generates a new HTTP request to that microservice and will wait for a response to it - which is used as a response to the original external request.</p>

<p>Microservices can make requests to each other via Control Tower. They  also have unrestricted access to the public internet, so 3rd party services can be accessed as they normally would be. The API infrastructure also has other resources, like databases (MongoDB, ElasticSearch, Postgres) or publish-subscribe queues (RabbitMQ), which can be accessed. We&rsquo;ll cover those in more details in a separate section.</p>

          <h1 id="control-tower">Control Tower</h1>

<p>This chapter covers Control Tower in depth - what it does and how it does it.</p>

<h2 id="overview">Overview</h2>

<p><a href="https://github.com/control-tower/control-tower">Control Tower</a> is essentially a mix of 3 main concepts:
- An API proxy/router
- A lightweight management API
- A plugin system to extend functionality and its own API.</p>

<p>We&rsquo;ll cover those 3 topics individually in this section.</p>

<h2 id="api-proxy-router">API proxy/router</h2>

<p>Control Tower&rsquo;s most basic functionality is accepting external requests to the API, &ldquo;forwarding&rdquo; them to the corresponding microservices, and returning whatever response the microservices produce.</p>

<p>Once an external request is received, Control Tower uses the HTTP request method and the URI of the request to match it to one of the known endpoints exposed internally by one of the microservices. Note that all external requests are handled exclusively by Control Tower, and microservices are no able to directly receive requests from outside the API&rsquo;s internal network (they can, however, make external requests).</p>

<p>This matching process can have one of two results:</p>

<h3 id="handling-a-matching-request">Handling a matching request</h3>

<p>Should a match be found for the external request&rsquo;s URI and method, a new, internal request is generated and dispatched to the corresponding microservice. The original external request will be blocked until the microservice replies to the internal request - and the internal request&rsquo;s reply will be used as the reply to the external request as soon as the corresponding microservice returns it.</p>

<aside class="notice">
By default, Control Tower does as little changes as necessary to the incoming external request and to the associated response produced by the microservice. However, for security, authentication/authorization, or due to external-to-internal endpoint mapping, changes will be made to requests and replies body, headers, etc.
</aside>

<h3 id="handling-a-non-matching-request">Handling a non-matching request</h3>

<h4 id="no-uri-and-method-match">No URI and method match</h4>

<p>At its most basic, the external requests is matched by URI and HTTP method. Should no combination of URI and method be found, Control Tower will reply to the external request with a <code class="prettyprint">404</code> HTTP code.</p>

<h4 id="authenticated">Authenticated</h4>

<p>Microservice endpoints can be marked as requiring authentication. If a matching request is received, but no user authentication data is provided in the request, Control Tower will reject the request with a <code class="prettyprint">401</code> HTTP code.</p>

<h4 id="application-key">Application key</h4>

<p>Similar to what happens with authenticated endpoints, microservice endpoints can also request an <code class="prettyprint">application</code> to be provided in the request. If that requirement is not fulfilled, Control Tower will reject the request with a <code class="prettyprint">401</code> HTTP code.</p>

<h4 id="filter-error">Filter error</h4>

<p>Registered endpoints also have the possibility to specify <code class="prettyprint">filters</code> - a custom requirement that must be met by the request in order for a request match to be successful. For example, endpoints associated with dataset operations use a common URI and HTTP method, but will be handled by different microservices depending on the type of dataset being used - this type of functionality can be implemented using the <code class="prettyprint">filter</code> functionality. On some scenarios, even if all the previous conditions are met, <code class="prettyprint">filters</code> may rule out a given match, in which case a <code class="prettyprint">401</code> HTTP code will be returned.</p>

<h3 id="microservice-registration-process">Microservice registration process</h3>

<p>The matching process described above is carried out by Control Tower based on endpoints declared by each microservice. In this section, we&rsquo;ll take a detailed look at the process through which microservices can declare their available endpoints to Control Tower</p>

<h4 id="overview">Overview</h4>

<p>Here&rsquo;s a graphical overview of the requests exchanged between CT and a microservice:</p>

<table><thead>
<tr>
<th>Control Tower</th>
<th style="text-align: center">Request</th>
<th style="text-align: right">Microservice</th>
</tr>
</thead><tbody>
<tr>
<td></td>
<td style="text-align: center">&lt;===   POST /v1/microservice  &lt;===</td>
<td style="text-align: right"></td>
</tr>
<tr>
<td></td>
<td style="text-align: center">{&ldquo;name&rdquo;:&ldquo;microservice name&rdquo;, &ldquo;url&rdquo;: &ldquo;http://microservice-url.com&rdquo;, &ldquo;active&rdquo;: true }</td>
<td style="text-align: right"></td>
</tr>
<tr>
<td></td>
<td style="text-align: center">===&gt;   Reply  ===&gt;</td>
<td style="text-align: right"></td>
</tr>
<tr>
<td></td>
<td style="text-align: center">HTTP OK</td>
<td style="text-align: right"></td>
</tr>
<tr>
<td></td>
<td style="text-align: center"></td>
<td style="text-align: right"></td>
</tr>
<tr>
<td></td>
<td style="text-align: center"></td>
<td style="text-align: right"></td>
</tr>
<tr>
<td></td>
<td style="text-align: center"></td>
<td style="text-align: right"></td>
</tr>
<tr>
<td></td>
<td style="text-align: center">===&gt;   GET /api/info  ===&gt;</td>
<td style="text-align: right"></td>
</tr>
<tr>
<td></td>
<td style="text-align: center">&lt;===   Reply  &lt;===</td>
<td style="text-align: right"></td>
</tr>
<tr>
<td></td>
<td style="text-align: center">{ /* JSON with microservice details */ }</td>
<td style="text-align: right"></td>
</tr>
<tr>
<td></td>
<td style="text-align: center"></td>
<td style="text-align: right"></td>
</tr>
<tr>
<td></td>
<td style="text-align: center"></td>
<td style="text-align: right"></td>
</tr>
<tr>
<td></td>
<td style="text-align: center"></td>
<td style="text-align: right"></td>
</tr>
<tr>
<td></td>
<td style="text-align: center">(every 30 seconds)</td>
<td style="text-align: right"></td>
</tr>
<tr>
<td></td>
<td style="text-align: center">===&gt;   GET /api/ping  ===&gt;</td>
<td style="text-align: right"></td>
</tr>
<tr>
<td></td>
<td style="text-align: center">&lt;===   Reply  &lt;===</td>
<td style="text-align: right"></td>
</tr>
<tr>
<td></td>
<td style="text-align: center">pong</td>
<td style="text-align: right"></td>
</tr>
</tbody></table>

<p>The registration process is started by the microservice. It announces its name, internal URL and active state to Control Tower. This tentatively registers the microservice in Control Tower&rsquo;s database, and triggers the next step of the process.</p>

<p>Immediately after receiving the initial request from the microservice, Control Tower uses the provided URL to reach the microservice. This is used not only to load the endpoint data, but also to ensure that Control Tower is able to reach the microservice at the provided URL - if that does not happen, the registration process is aborted on Control Tower&rsquo;s side, and the microservice data dropped. When it receives this request, the microservice should reply with a JSON array of supported endpoints. We&rsquo;ll dive deeper into the structure of that reply in a moment.</p>

<p>The last step of the process is Control Tower processing that JSON entity, and storing its data in its database. From this point on, the microservice is registered and is able to receive user requests through Control Tower.</p>

<p>Control Tower will, every 30 seconds, emit a <code class="prettyprint">ping</code> request to the microservice, which must reply to it to confirm to Control Tower that it&rsquo;s still functional. Should the microservice fail to reply to a ping request, Control Tower will assume its failure, and de-register the microservice and associated endpoints. Should this happen, it&rsquo;s up to the microservice to re-register itself on Control Tower, to be able to continue accepting requests.</p>

<h4 id="minimal-configuration">Minimal configuration</h4>

<p>During the registration process, each microservice is responsible for informing Control Tower of the endpoints it supports, if they require authentication, application info, etc. This is done through a JSON object, that has the following basic structure:</p>
<pre class="highlight json"><code><span class="p">{</span><span class="w">
    </span><span class="s2">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"dataset"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"tags"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"dataset"</span><span class="p">],</span><span class="w">
    </span><span class="s2">"endpoints"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="s2">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/v1/dataset"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"method"</span><span class="p">:</span><span class="w"> </span><span class="s2">"GET"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"redirect"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="s2">"method"</span><span class="p">:</span><span class="w"> </span><span class="s2">"GET"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/api/v1/dataset"</span><span class="w">
            </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">],</span><span class="w">
    </span><span class="s2">"swagger"</span><span class="p">:</span><span class="w"> </span><span class="p">{}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
<p>Breaking it down bit by bit:</p>

<ul>
<li><code class="prettyprint">name</code>: Name of the microservice.</li>
<li><code class="prettyprint">tags</code>: List of tags associated with the microservice.</li>
<li><code class="prettyprint">endpoints</code>: Array of <code class="prettyprint">endpoint</code> objects.</li>
<li><code class="prettyprint">swagger</code>: <a href="https://swagger.io/">Swagger</a> formatted JSON object documenting the microservice&rsquo;s endpoints.</li>
</ul>

<p>Within the <code class="prettyprint">endpoints</code> array, the expected object structure is the following: </p>

<ul>
<li><code class="prettyprint">path</code>: Expected external request URI that will match to this endpoint.</li>
<li><code class="prettyprint">method</code>: Expected external request method that will match to this endpoint.</li>
<li><code class="prettyprint">redirect.method</code>: Method to use in the internal request to the microservice.</li>
<li><code class="prettyprint">redirect.path</code>: URI to use in the internal request to the microservice.</li>
</ul>

<p>Taking the example above, that reply would be provided by the <code class="prettyprint">dataset</code> microservice while registering on Control Tower. It would tell CT that it has a single public endpoint, available at GET <code class="prettyprint">&lt;api public URL&gt;/v1/dataset</code>. When receiving that external request, the <code class="prettyprint">redirect</code> portion of the endpoint configuration tells CT to issue a GET request to <code class="prettyprint">&lt;microservice URL&gt;/api/v1/dataset</code>. It then follows the process previously described to handle the reply from the microservice and return its content to the user.</p>

<h4 id="advanced-configuration">Advanced configuration</h4>

<p>The example from the previous section covers the bare minimum a microservice needs to provide to Control Tower in order to register an endpoint. However, as discussed before, Control Tower can also provide support for more advanced features, like authentication and application data filtering. The JSON <code class="prettyprint">endpoint</code> snippet below shows how these optional parameters can be used to configure said functionality. </p>
<pre class="highlight json"><code><span class="p">{</span><span class="w">
    </span><span class="s2">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"query-document"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"tags"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"query-document"</span><span class="p">],</span><span class="w">
    </span><span class="s2">"endpoints"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="s2">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/v1/query/:dataset"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"method"</span><span class="p">:</span><span class="w"> </span><span class="s2">"GET"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"binary"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
            </span><span class="s2">"authenticated"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
            </span><span class="s2">"applicationRequired"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
            </span><span class="s2">"redirect"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="s2">"method"</span><span class="p">:</span><span class="w"> </span><span class="s2">"POST"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/api/v1/document/query/:dataset"</span><span class="w">
            </span><span class="p">},</span><span class="w">
            </span><span class="s2">"filters"</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span><span class="w">
                </span><span class="s2">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"dataset"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/v1/dataset/:dataset"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"method"</span><span class="p">:</span><span class="w"> </span><span class="s2">"GET"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"params"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                    </span><span class="s2">"dataset"</span><span class="p">:</span><span class="w"> </span><span class="s2">"dataset"</span><span class="w">
                </span><span class="p">},</span><span class="w">
                </span><span class="s2">"compare"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                    </span><span class="s2">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                        </span><span class="s2">"attributes"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                            </span><span class="s2">"connectorType"</span><span class="p">:</span><span class="w"> </span><span class="s2">"document"</span><span class="w">
                        </span><span class="p">}</span><span class="w">
                    </span><span class="p">}</span><span class="w">
                </span><span class="p">}</span><span class="w">
            </span><span class="p">}]</span><span class="w">
        </span><span class="p">}</span><span class="w">   
    </span><span class="p">]</span><span class="w">
 </span><span class="p">}</span><span class="w">
</span></code></pre>
<p>Within the <code class="prettyprint">endpoints</code> array, you&rsquo;ll notice a few changes. The <code class="prettyprint">path</code> property now includes an URI which contains <code class="prettyprint">:dataset</code> in it - this notation tells Control Tower to expect a random value in that part of the URI (delimited by <code class="prettyprint">/</code>) and to refer to that value as <code class="prettyprint">dataset</code> in other parts of the process.</p>

<p>The <code class="prettyprint">redirect.path</code> references the same <code class="prettyprint">:dataset</code> value - meaning the incoming value from the external request will be passed on to the internal requests to the microservice generated by Control Tower.</p>

<p>You&rsquo;ll also notice new fields that were not present before: </p>

<ul>
<li><code class="prettyprint">binary</code>: Using this causes Control Tower to pipe the microservice&rsquo;s response content as a binary stream to the external request&rsquo;s reply. Use this in case you expect your microservice&rsquo;s replies to have large amounts of binary data - for example, a file for download.</li>
<li><code class="prettyprint">authenticated</code>: Setting this to <code class="prettyprint">true</code> causes Control Tower to immediately return an HTTP <code class="prettyprint">401</code> error code in case this endpoint matches the external request, but that request has no user identification data.</li>
<li><code class="prettyprint">applicationRequired</code>: Setting this to <code class="prettyprint">true</code> causes Control Tower to immediately return an HTTP <code class="prettyprint">401</code> error code in case this endpoint matches the external request, but that request has no application data as part of the user&rsquo;s data.</li>
<li><code class="prettyprint">filters</code>: An array of filter objects that the request must match to in order for a match to be considered successful.</li>
<li><code class="prettyprint">filters.name</code>: A name for the filter, without functional implications.</li>
<li><code class="prettyprint">filters.method</code>: Method to use in the filter request.</li>
<li><code class="prettyprint">filters.path</code>: URI to use in the filter request.</li>
<li><code class="prettyprint">filters.params</code>: Query parameters passed to the filter request.</li>
<li><code class="prettyprint">filters.compare</code>: Response structure to be matched with the filter request reply, to determine if the external request matches this filter.</li>
</ul>

<p>The filtering section has the most complex structure, so lets analyse it with a real-world example. The above example would match a request like GET <code class="prettyprint">&lt;api external URL&gt;/v1/query/&lt;dataset id&gt;</code>. Once that request is received by Control Tower, it is tentatively matched to this endpoint, but pending the validation of the filter section.</p>

<p>To process the filter, Control Tower will do a request of type <code class="prettyprint">filters.method</code> (GET, in this case) and URI <code class="prettyprint">filters.path</code>. As the URI contains a <code class="prettyprint">:dataset</code> variable, it will use the <code class="prettyprint">filters.params</code> object to map that value to the <code class="prettyprint">dataset</code> value from the external request. This internal request is then issued and the process briefly stopped until a response is returned.</p>

<p>Once the response is returned, the <code class="prettyprint">filters.compare</code> object comes into play: Control Tower will see if the response body object matches the set value in the <code class="prettyprint">filters.compare</code> object. In this particular example, the resulting comparison would be something like <code class="prettyprint">response.body.data.attributes.connectorType == &quot;document&quot;</code>. Should this evaluate to <code class="prettyprint">true</code>, the filter is considered to have matched, and this endpoint is used to dispatch the internal request to. Otherwise, this endpoint is discarded from the list of possible matches for this external request.</p>

<p>The data loaded as part of the filtering process is then passed on to the microservice that will handle that call, either as query arguments (DELETE or GET requests) or as part of the body (PATCH, POST and PUT requests). The query param/body property is named after the <code class="prettyprint">filter.name</code> value configured in the filter. In our example, the request issued to the microservice that matches the filter would be of type POST, so its body will contain a <code class="prettyprint">dataset</code> property containing the response from querying the filter endpoint - <code class="prettyprint">/v1/dataset/:dataset</code>. <aside class="notice">Automatically passing filter data in the request generated to the microservice is now deprecated, and all microservices should instead load the necessary data by calling the respective microservices themselves.</aside> </p>

<p>Its worth noting at this stage that there&rsquo;s no restriction regarding uniqueness of internal endpoints - two microservices may support the same endpoint, and use filters to differentiate between them based on the underlying data. The example above illustrates how a microservice can support the <code class="prettyprint">/v1/query/:dataset</code> external endpoint, but only for datasets of type <code class="prettyprint">document</code>. A different microservice may support the same endpoint, but with a different filter value (for example <code class="prettyprint">carto</code>) and offer the same external functionality with a completely different underlying implementation.</p>

<p>Should multiple endpoints match an external request, one of them is chosen and used - there are no guarantees in terms of which is picked, so while this scenario does not produce an error, you probably want to avoid it.</p>

<h2 id="management-api">Management API</h2>

<p>In the previous section, we discussed how microservices can register their endpoint on Control Tower, exposing their functionality to the outside world. That registration process uses part of Control Tower&rsquo;s own API, which we&rsquo;ll discuss in finer detail in this section.</p>

<h3 id="microservice-management-endpoints">Microservice management endpoints</h3>

<p>The microservice registration endpoint is one of 4 endpoints that exist around microservice management:</p>

<h4 id="get-microservice">GET <code class="prettyprint">/microservice/</code></h4>

<p>This endpoint shows a list of registered microservice and their corresponding endpoints.</p>
<pre class="highlight shell"><code>curl -X GET <span class="se">\</span>
  http://&lt;CT URL&gt;/api/v1/microservice <span class="se">\</span>
  -H <span class="s1">'Authorization: Bearer &lt;your user token&gt;'</span> <span class="se">\</span>
  -H <span class="s1">'Content-Type: application/json'</span>
</code></pre><pre class="highlight json"><code><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
        </span><span class="s2">"infoStatus"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="s2">"numRetries"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
            </span><span class="s2">"error"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
            </span><span class="s2">"lastCheck"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2018-12-05T07:33:30.244Z"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="s2">"pathInfo"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/info"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"pathLive"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/ping"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"status"</span><span class="p">:</span><span class="w"> </span><span class="s2">"active"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"cache"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">
        </span><span class="s2">"uncache"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">
        </span><span class="s2">"tags"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
            </span><span class="s2">"dataset"</span><span class="w">
        </span><span class="p">],</span><span class="w">
        </span><span class="s2">"_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"5aa66766aee7ae846a419c0c"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Dataset"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"url"</span><span class="p">:</span><span class="w"> </span><span class="s2">"http://dataset.default.svc.cluster.local:3000"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"version"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
        </span><span class="s2">"endpoints"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
            </span><span class="p">{</span><span class="w">
                </span><span class="s2">"redirect"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                    </span><span class="s2">"method"</span><span class="p">:</span><span class="w"> </span><span class="s2">"GET"</span><span class="p">,</span><span class="w">
                    </span><span class="s2">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/api/v1/dataset"</span><span class="w">
                </span><span class="p">},</span><span class="w">
                </span><span class="s2">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/v1/dataset"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"method"</span><span class="p">:</span><span class="w"> </span><span class="s2">"GET"</span><span class="w">
            </span><span class="p">}</span><span class="w">
        </span><span class="p">],</span><span class="w">
        </span><span class="s2">"updatedAt"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2018-11-23T14:27:10.957Z"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"swagger"</span><span class="p">:</span><span class="w"> </span><span class="s2">"{}"</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">]</span><span class="w">
</span></code></pre>
<h4 id="get-microservice-status">GET <code class="prettyprint">/microservice/status</code></h4>

<p>Lists information about operational status of each microservice - like errors detected by Control Tower trying to contact the microservice or number of retries attempted.</p>
<pre class="highlight shell"><code>curl -X GET <span class="se">\</span>
  http://&lt;CT URL&gt;/api/v1/microservice/status <span class="se">\</span>
  -H <span class="s1">'Authorization: Bearer &lt;your user token&gt;'</span> <span class="se">\</span>
  -H <span class="s1">'Content-Type: application/json'</span>
</code></pre><pre class="highlight json"><code><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
        </span><span class="s2">"infoStatus"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="s2">"numRetries"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
            </span><span class="s2">"error"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
            </span><span class="s2">"lastCheck"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2018-12-05T07:36:30.199Z"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="s2">"status"</span><span class="p">:</span><span class="w"> </span><span class="s2">"active"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Dataset"</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">]</span><span class="w">
</span></code></pre>
<h4 id="post-microservice">POST <code class="prettyprint">/microservice/</code></h4>

<p>This is the endpoint used by microservices to register on Control Tower. You can find a detailed analysis of its syntax in the <a href="#api-proxy-router">previous section</a></p>

<h4 id="delete-microservice-id">DELETE <code class="prettyprint">/microservice/:id</code></h4>

<p>This endpoint is used to unregister a microservice&rsquo;s endpoints from Control Tower. Control Tower does not actually delete the microservice information, nor does it immediately remove the endpoints associated to it. This endpoint iterates over all endpoint associated with the microservice to be unregistered, and flags them for deletion - which is actually done by a cron task that in the background. Until that moment, the microservice and associated endpoints will continue to be available, and external requests to those endpoints will be handled as matched as they were before. However, you will notice that endpoints scheduled for deletion will have a <code class="prettyprint">toDelete</code> value of true - more on this in the next section.</p>
<pre class="highlight shell"><code>curl -X DELETE <span class="se">\</span>
  http://&lt;CT URL&gt;/api/v1/microservice/&lt;microservice id&gt; <span class="se">\</span>
  -H <span class="s1">'Authorization: Bearer &lt;your user token&gt;'</span> <span class="se">\</span>
  -H <span class="s1">'Content-Type: application/json'</span>
</code></pre><pre class="highlight json"><code><span class="p">{</span><span class="w">
    </span><span class="s2">"infoStatus"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"numRetries"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="s2">"pathInfo"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/info"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"pathLive"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/ping"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"status"</span><span class="p">:</span><span class="w"> </span><span class="s2">"active"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"cache"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">
    </span><span class="s2">"uncache"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">
    </span><span class="s2">"tags"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"dataset"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"dataset"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"dataset"</span><span class="w">
    </span><span class="p">],</span><span class="w">
    </span><span class="s2">"_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"5c0782831b0bf92a37a754e2"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Dataset"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"url"</span><span class="p">:</span><span class="w"> </span><span class="s2">"http://127.0.0.1:3001"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"version"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
    </span><span class="s2">"updatedAt"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2018-12-05T07:49:36.754Z"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"endpoints"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="s2">"redirect"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="s2">"method"</span><span class="p">:</span><span class="w"> </span><span class="s2">"GET"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/api/v1/dataset"</span><span class="w">
            </span><span class="p">},</span><span class="w">
            </span><span class="s2">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/v1/dataset"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"method"</span><span class="p">:</span><span class="w"> </span><span class="s2">"GET"</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">],</span><span class="w">
    </span><span class="s2">"swagger"</span><span class="p">:</span><span class="w"> </span><span class="s2">"{}"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
<h3 id="endpoint-management-endpoints">Endpoint management endpoints</h3>

<h4 id="get-endpoint">GET <code class="prettyprint">/endpoint</code></h4>

<p>This endpoint lists all microservice endpoint known by Control Tower. Note that it does not contain endpoints offered by Control Tower itself or any of its plugins.</p>
<pre class="highlight shell"><code>curl -X GET <span class="se">\</span>
  http://&lt;CT URL&gt;/api/v1/endpoint <span class="se">\</span>
  -H <span class="s1">'Authorization: Bearer &lt;your user token&gt;'</span> <span class="se">\</span>
  -H <span class="s1">'Content-Type: application/json'</span>
</code></pre><pre class="highlight json"><code><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
        </span><span class="s2">"pathKeys"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">
        </span><span class="s2">"authenticated"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
        </span><span class="s2">"applicationRequired"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
        </span><span class="s2">"binary"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
        </span><span class="s2">"cache"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">
        </span><span class="s2">"uncache"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">
        </span><span class="s2">"toDelete"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
        </span><span class="s2">"_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"5c0784c88dcce0323abe705d"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/v1/dataset"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"method"</span><span class="p">:</span><span class="w"> </span><span class="s2">"GET"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"pathRegex"</span><span class="p">:</span><span class="w"> </span><span class="p">{},</span><span class="w">
        </span><span class="s2">"redirect"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
            </span><span class="p">{</span><span class="w">
                </span><span class="s2">"filters"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
                </span><span class="s2">"_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"5c0784c88dcce0323abe705e"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"method"</span><span class="p">:</span><span class="w"> </span><span class="s2">"GET"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/api/v1/dataset"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"url"</span><span class="p">:</span><span class="w"> </span><span class="s2">"http://127.0.0.1:3001"</span><span class="w">
            </span><span class="p">}</span><span class="w">
        </span><span class="p">],</span><span class="w">
        </span><span class="s2">"version"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">]</span><span class="w">
</span></code></pre>
<h4 id="delete-endpoint-purge-all">DELETE <code class="prettyprint">/endpoint/purge-all</code></h4>

<p>This endpoint purges the complete HTTP cache for all microservices. It does not support any kind of parametrization, so it&rsquo;s not possible to use this endpoint to clear only parts of the cache. As such, we recommend not using this endpoint unless you are certain of its consequences, as it will have noticeable impact in end-user perceived performance.</p>
<pre class="highlight shell"><code>curl -X DELETE <span class="se">\</span>
  http://&lt;CT URL&gt;/api/v1/endpoint/purge-all <span class="se">\</span>
  -H <span class="s1">'Authorization: Bearer &lt;your user token&gt;'</span> <span class="se">\</span>
  -H <span class="s1">'Content-Type: application/json'</span>
</code></pre>
<h3 id="documentation-management-endpoints">Documentation management endpoints</h3>

<h4 id="get-doc-swagger">GET <code class="prettyprint">/doc/swagger</code></h4>

<p>Generates a complete <a href="https://swagger.io/">Swagger</a> JSON file documenting all API endpoints. This swagger is compiled by Control Tower based on Swagger files provided by each microservice. As such, the Swagger details for a given endpoint will only be as good as the information provided by the microservice itself.</p>

<aside class="notice">
This
</aside>
<pre class="highlight shell"><code>curl -X GET <span class="se">\</span>
  http://&lt;CT URL&gt;/api/v1/endpoint <span class="se">\</span>
  -H <span class="s1">'Authorization: Bearer &lt;your user token&gt;'</span> <span class="se">\</span>
  -H <span class="s1">'Content-Type: application/json'</span>
</code></pre><pre class="highlight json"><code><span class="p">{</span><span class="w">
    </span><span class="s2">"swagger"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2.0"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"info"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"title"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Control Tower"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Control Tower - API"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"1.0.0"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="s2">"host"</span><span class="p">:</span><span class="w"> </span><span class="s2">"tower.dev:9000"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"schemes"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"http"</span><span class="w">
    </span><span class="p">],</span><span class="w">
    </span><span class="s2">"produces"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"application/vnd.api+json"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"application/json"</span><span class="w">
    </span><span class="p">],</span><span class="w">
    </span><span class="s2">"paths"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"/api/v1/doc/swagger"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="s2">"get"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="s2">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Return swagger files of registered microservices"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"operationId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"getSwagger"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"tags"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                    </span><span class="s2">"ControlTower"</span><span class="w">
                </span><span class="p">],</span><span class="w">
                </span><span class="s2">"produces"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                    </span><span class="s2">"application/json"</span><span class="p">,</span><span class="w">
                    </span><span class="s2">"application/vnd.api+json"</span><span class="w">
                </span><span class="p">],</span><span class="w">
                </span><span class="s2">"responses"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                    </span><span class="s2">"200"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                        </span><span class="s2">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Swagger json"</span><span class="w">
                    </span><span class="p">},</span><span class="w">
                    </span><span class="s2">"500"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                        </span><span class="s2">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Unexpected error"</span><span class="p">,</span><span class="w">
                        </span><span class="s2">"schema"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                            </span><span class="s2">"$ref"</span><span class="p">:</span><span class="w"> </span><span class="s2">"#/definitions/Errors"</span><span class="w">
                        </span><span class="p">}</span><span class="w">
                    </span><span class="p">}</span><span class="w">
                </span><span class="p">}</span><span class="w">
            </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="s2">"definitions"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"Errors"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="s2">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"object"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Errors"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="s2">"errors"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                    </span><span class="s2">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"array"</span><span class="p">,</span><span class="w">
                    </span><span class="s2">"items"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                        </span><span class="s2">"$ref"</span><span class="p">:</span><span class="w"> </span><span class="s2">"#/definitions/Error"</span><span class="w">
                    </span><span class="p">}</span><span class="w">
                </span><span class="p">}</span><span class="w">
            </span><span class="p">}</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="s2">"Error"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="s2">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"object"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="s2">"id"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                    </span><span class="s2">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"integer"</span><span class="p">,</span><span class="w">
                    </span><span class="s2">"format"</span><span class="p">:</span><span class="w"> </span><span class="s2">"int32"</span><span class="p">,</span><span class="w">
                    </span><span class="s2">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"A unique identifier for this particular occurrence of the problem."</span><span class="w">
                </span><span class="p">},</span><span class="w">
                </span><span class="s2">"links"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                    </span><span class="s2">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"object"</span><span class="p">,</span><span class="w">
                    </span><span class="s2">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"A links object"</span><span class="p">,</span><span class="w">
                    </span><span class="s2">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                        </span><span class="s2">"about"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                            </span><span class="s2">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w">
                            </span><span class="s2">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"A link that leads to further details about this particular occurrence of the problem."</span><span class="w">
                        </span><span class="p">}</span><span class="w">
                    </span><span class="p">}</span><span class="w">
                </span><span class="p">},</span><span class="w">
                </span><span class="s2">"status"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                    </span><span class="s2">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w">
                    </span><span class="s2">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"The HTTP status code applicable to this problem, expressed as a string value"</span><span class="w">
                </span><span class="p">},</span><span class="w">
                </span><span class="s2">"code"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                    </span><span class="s2">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w">
                    </span><span class="s2">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"An application-specific error code, expressed as a string value"</span><span class="w">
                </span><span class="p">},</span><span class="w">
                </span><span class="s2">"title"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                    </span><span class="s2">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w">
                    </span><span class="s2">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"A short, human-readable summary of the problem that SHOULD NOT change from occurrence to occurrence of the problem, except for purposes of localization."</span><span class="w">
                </span><span class="p">},</span><span class="w">
                </span><span class="s2">"detail"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                    </span><span class="s2">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w">
                    </span><span class="s2">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"A human-readable explanation specific to this occurrence of the problem. Like title, this field's value can be localized"</span><span class="w">
                </span><span class="p">},</span><span class="w">
                </span><span class="s2">"source"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                    </span><span class="s2">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"object"</span><span class="p">,</span><span class="w">
                    </span><span class="s2">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"An object containing references to the source of the error, optionally including any of the following members"</span><span class="p">,</span><span class="w">
                    </span><span class="s2">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                        </span><span class="s2">"pointer"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                            </span><span class="s2">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w">
                            </span><span class="s2">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"A JSON Pointer [RFC6901] to the associated entity in the request document"</span><span class="w">
                        </span><span class="p">},</span><span class="w">
                        </span><span class="s2">"parameter"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                            </span><span class="s2">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span><span class="w">
                            </span><span class="s2">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"A string indicating which URI query parameter caused the error."</span><span class="w">
                        </span><span class="p">}</span><span class="w">
                    </span><span class="p">}</span><span class="w">
                </span><span class="p">},</span><span class="w">
                </span><span class="s2">"meta"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                    </span><span class="s2">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"object"</span><span class="p">,</span><span class="w">
                    </span><span class="s2">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"A meta object containing non-standard meta-information about the error."</span><span class="w">
                </span><span class="p">}</span><span class="w">
            </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
<h3 id="plugin-management-endpoints">Plugin management endpoints</h3>

<p>Control Tower as a plugin system of its own, which we&rsquo;ll cover in detail in the next section. As part of that system it has a few API endpoints to support certain actions</p>

<h4 id="get-plugin">GET <code class="prettyprint">/plugin</code></h4>

<p>Lists all currently enabled plugins, along with their configuration.</p>
<pre class="highlight shell"><code>curl -X GET <span class="se">\</span>
  http://&lt;CT URL&gt;/api/v1/plugin <span class="se">\</span>
  -H <span class="s1">'Authorization: Bearer &lt;your user token&gt;'</span> <span class="se">\</span>
  -H <span class="s1">'Content-Type: application/json'</span>
</code></pre><pre class="highlight json"><code><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
        </span><span class="s2">"active"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
        </span><span class="s2">"_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"5bfd440834d5076bb4609f9f"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"manageErrors"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Manage Errors"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"mainFile"</span><span class="p">:</span><span class="w"> </span><span class="s2">"plugins/manageErrors"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"config"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="s2">"jsonAPIErrors"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">]</span><span class="w">
</span></code></pre>
<h4 id="patch-plugin-id">PATCH <code class="prettyprint">/plugin/:id</code></h4>

<p>Updates the settings of a given plugin.</p>
<pre class="highlight shell"><code>curl -X PATCH <span class="se">\</span>
  http://&lt;CT URL&gt;/api/v1/plugin/:pluginId <span class="se">\</span>
  -H <span class="s1">'Authorization: Bearer &lt;your user token&gt;'</span> <span class="se">\</span>
  -H <span class="s1">'Content-Type: application/json'</span> <span class="se">\</span>
  -d <span class="s1">'{
    "config": {
        "jsonAPIErrors": false
    }
}'</span>
</code></pre><pre class="highlight json"><code><span class="p">{</span><span class="w">
    </span><span class="s2">"_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"5bfd440834d5076bb4609f9f"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"manageErrors"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Manage Errors"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"mainFile"</span><span class="p">:</span><span class="w"> </span><span class="s2">"plugins/manageErrors"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"config"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"jsonAPIErrors"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
<h2 id="control-tower-plugins">Control Tower plugins</h2>

<p>Control Tower provides basic API management functionality, but it also has a set of plugins that allow decoupling non-core functionality from the core code base. In this section we&rsquo;ll briefly cover the functional aspect of each plugin, without focusing too much on the underlying implementation, which will be covered separately.</p>

<h3 id="time-request">Time Request</h3>

<p>This plugin times the time elapsed between the external request is received and the reply to it being dispatched back to the external API client. It adds the computed value as a response header <code class="prettyprint">X-Response-Time</code></p>

<h3 id="manage-errors">Manage errors</h3>

<p>This plugin intercepts replies that represent errors and formats them properly.</p>

<h3 id="cors">CORS</h3>

<p>This plugins adds the necessary headers to support <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS">CORS</a></p>

<h3 id="invalidate-cache-endpoints">Invalidate cache endpoints</h3>

<p>Varnish cache integration plugin that invalidates cache entries.</p>

<aside class="notice">
This plugin is disabled and is no longer supported.
</aside>

<h3 id="response-formatter">Response formatter</h3>

<p>Handles response formats other than the default JSON, setting headers and formatting the response body according to the requested content type. Currently only supports XML.</p>

<h3 id="statistics">Statistics</h3>

<p>Collects and stores statistics about the API usage.</p>

<h3 id="mongodb-sessions">MongoDB sessions</h3>

<p>Adds support for storing session data on MongoDB</p>

<h3 id="oauth-plugin">Oauth plugin</h3>

<p>User management and authentication plugin. Supports email+password based registration, as well as Facebook, Twitter and Google+ oauth-based authentication.</p>

<h3 id="redis-cache">Redis cache</h3>

<p>Redis-based caching for Control Tower. </p>

<aside class="notice">
This plugin is disabled and is no longer supported.
</aside>

<h3 id="application-key-authorization">Application key authorization</h3>

<p>Application key handling.</p>

<h3 id="fastly-cache">Fastly cache</h3>

<p>Integrates HTTP caching using <a href="https://www.fastly.com/">Fastly</a>.</p>

<h3 id="read-only-mode">Read-only mode</h3>

<blockquote>
<p>Rejected endpoints will have HTTP status 503 and the following message:</p>
</blockquote>
<pre class="highlight json"><code><span class="s2">"API under maintenance, please try again later."</span><span class="w">
</span></code></pre>
<blockquote>
<p>Configuration of white and black lists:</p>
</blockquote>
<pre class="highlight javascript"><code><span class="p">{</span>
    <span class="c1">// This blacklist prevents GETting widgets</span>
    <span class="s2">"blacklist"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"/api/v1/widget"</span><span class="p">],</span>

    <span class="c1">// This whitelist allows POST/PATCH/DELETE calls for datasets and layers</span>
    <span class="s2">"whitelist"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"/api/v1/dataset"</span><span class="p">,</span> <span class="s2">"/api/v1/layer"</span><span class="p">]</span>
<span class="p">}</span>
</code></pre>
<p>This plugin activates a <strong>read-only mode</strong> that passes through all calls to GET endpoints and rejects calls to POST/PATCH/PUT/DELETE endpoints. The plugin provides the following configurations for increased flexibility:</p>

<ul>
<li><code class="prettyprint">whitelist</code>: An array of POST/PATCH/PUT/DELETE endpoints that should be passed through. Each item of the array should be a string matching exactly the path to whitelist.</li>
<li><code class="prettyprint">blacklist</code>: An array of GET endpoints that should be rejected. Each item of the array should be a string matching exactly the path to blacklist.</li>
</ul>

<p><strong>Note: Please ensure you know what you&rsquo;re doing when activating this plugin, since it will highly restrict the usage of the API.</strong></p>

          <h1 id="control-tower-plugin-development">Control Tower plugin development</h1>

<p>This chapter covers Control Tower plugin development basics. It aims at providing basic understanding of how existing Control Tower plugins work, and give you the foundations to develop your own plugins.</p>

<h2 id="implementing-functionality">Implementing functionality</h2>

<p>Control Tower and its plugins are implemented using Nodejs and <a href="https://koajs.com/">Koa</a>. Be sure to familiarize yourself with the key concepts behind this framework before exploring this section, as it assumes you are comfortable with concepts like route declaration or koa middleware.</p>

<p>Existing plugin functionality for Control Tower falls within one of two categories: middleware that intercepts requests as they are processed by Control Tower, or new endpoints that are added to Control Tower&rsquo;s API. Some plugins combine the two approaches to implement their functionality.</p>

<h3 id="middleware">Middleware</h3>

<p>Middleware-based functionality consists of intercepting the external request and/or response and either gathering data about them (for logging or statistics) or modifying them (for example, for caching). This type of functionality can be implemented using koa&rsquo;s middleware API, as Control Tower itself does not modify or extend that in any way.</p>

<h3 id="endpoint-creation">Endpoint creation</h3>

<p>Plugins can also extend Control Tower&rsquo;s endpoint list by registering new endpoints of their own. An example of this is the Control Tower Oauth plugin that exposes a number of endpoints to support actions like registering, logging in, recovering password, etc. Like with the middleware approach, this can be implemented by relying on koa principles, and Control Tower does not modify this behavior.</p>

<h2 id="data-storage">Data storage</h2>

<p>Control Tower uses a Mongo database to store data like known microservices or endpoints. Plugins can also access this database and create their own collections, should they wish to. Control Tower and existing plugins rely on <a href="https://mongoosejs.com/">Mongoose</a> to that effect, and you&rsquo;ll find example of its usage throughout Control Tower and its plugins code.</p>

<h2 id="plugin-bootstrap-and-config">Plugin bootstrap and config</h2>

<p>During its first initialization, Control Tower will load plugin settings from <a href="https://github.com/control-tower/control-tower/blob/develop/app/src/migrations/init.js">this file</a>. It includes a list of plugins to be initialized, whether or not they should be active, and their default configuration. On subsequent executions, this information will be loaded from the database instead, so additional changes you may want to do should be done on the database, and not on this file.</p>

<p>An important part of this file and of the corresponding database entries is plugin configuration. This data is stored within the <code class="prettyprint">plugins</code> MongoDB collection managed by Control Tower but it&rsquo;s made available to plugins as they are initialized and ran.</p>

          <h1 id="microservice-development-guide">Microservice development guide</h1>

<p>In this chapter, we&rsquo;ll cover additional details that you, as a RW API developer, should keep in mind when developing your microservice. We&rsquo;ll focus not only on the technical requirements you need to meet for your microservice to communicate with the remaining RW API internal components, but also discuss the policy surrounding development for the RW API, as a way to achieve a certain degree of consistency across a naturally heterogeneous microservice-based system. </p>

<aside class="notice">
Control Tower, which is mentioned throughout these docs, will be replaced soon with an equivalent but alternative solution. While we will aim to have this transition be as seamless as possible, you may need to adapt your code once this is done.
</aside>

<h2 id="microservice-overview">Microservice overview</h2>

<p>As described in the <a href="#api-architecture">API Architecture</a> section, microservices are small web applications that expose a REST API through a web server. This means that microservices can be built using any programming language, just as long as it supports HTTP communication. In practical terms, most of this API&rsquo;s core microservices are built using <a href="https://nodejs.org">nodejs</a>, with <a href="https://www.python.org/">python</a> and <a href="https://rubyonrails.org/">Rails</a> being distant 2nd and 3rd respectively. This is due to personal preference of the team behind the API, as there really isn&rsquo;t a technical reason or limitation preventing the creation of microservices in PHP, Go, Elixir, etc.</p>

<p>In this whole section, we will use code examples from the <a href="https://github.com/resource-watch/dataset/">Dataset microservice</a>, which is built using nodejs. We will discuss the general principles, which should apply to all implementations, as well as implementation details, which may apply to your scenario if you are also using nodejs, or that may not apply if you are using something else.</p>

<h2 id="microservice-internal-architecture-nodejs">Microservice internal architecture - nodejs</h2>

<aside class="notice">
This section is completely implementation specific and opinionated, and does not reflect any technical requirement of the API. However, as all nodejs microservices use this architecture, we will cover it here as it&rsquo;s useful for new developers. Other microservice implementations in other languages will have different architectures, and you can also implement your own microservice using nodejs using a totally different architecture. Take this whole section as information/suggestion rather than as a ruleset.
</aside>

<p>Nodejs microservices are based on the <a href="https://koajs.com/">Koa</a> framework for nodejs. To understand the following code snippets, we assume you are familiar with the basics of the framework, like how routes are declared and handled, what middleware is, and how it works. You should also be somewhat familiar with tools like <a href="https://www.npmjs.com/">npm</a>, <a href="https://www.mongodb.com/">mongo</a> and <a href="https://mongoosejs.com/">mongoose</a>, <a href="https://jenkins.io/">Jenkins CI</a>, <a href="https://www.docker.com/">docker</a> and <a href="https://docs.docker.com/compose/">docker-compose</a></p>

<h3 id="anatomy-of-a-nodejs-microservice">Anatomy of a (nodejs) microservice</h3>

<p>In this section, we&rsquo;ll use <a href="https://github.com/resource-watch/dataset">the dataset microservice</a> as an example, but these concepts should apply to most if not all nodejs microservices:</p>

<ul>
<li>app: source code for the microservice functionality.</li>
<li>config: configuration for different environments in which the microservice will be executed.</li>
<li>k8s: <a href="https://kubernetes.io/">kubernetes</a> configuration.</li>
<li>Jenkinsfile: deployment configuration for <a href="https://jenkins.io/">Jenkins CI</a>.</li>
<li>dataset.sh: convenience executable file (the name will always match the microservice).</li>
<li>docker-compose-develop.yml: <a href="https://docs.docker.com/compose/">docker-compose</a> configuration for develop environment.</li>
<li>docker-compose-test.yml: <a href="https://docs.docker.com/compose/">docker-compose</a> configuration for test environment.</li>
<li>docker-compose.yml: <a href="https://docs.docker.com/compose/">docker-compose</a> configuration for production environment.</li>
<li>entrypoint.sh: <a href="https://www.docker.com/">docker</a> entry point.</li>
</ul>

<p>Since we are interested in the microservice&rsquo;s functional bits, we&rsquo;ll analyse the <code class="prettyprint">app</code> folder content in more detail. It&rsquo;s worth mentioning that, depending on how you run the microservice, the respective <code class="prettyprint">docker compose</code> files may contain relevant information and configuration, as do the files inside the <code class="prettyprint">config</code> folder.</p>

<p>The <code class="prettyprint">app</code> folder contains the following structure:</p>

<ul>
<li>microservice: JSON files used during the Control Tower registration process.</li>
<li>src: source code for the microservice.</li>
<li>test: test source code.</li>
<li>Gruntfile.js: <a href="https://gruntjs.com/">grunt</a> task definition file.</li>
<li>index.js: nodejs entry point.</li>
</ul>

<p>The grunt file includes several task definition that may be useful during day-to-day development. However, grunt is semi-deprecated (it&rsquo;s still needed, don&rsquo;t remove it) in the sense that it&rsquo;s recommended to define useful tasks in the <code class="prettyprint">package.json</code> file instead - those tasks will, in turn, call grunt tasks.</p>

<p>Inside the <code class="prettyprint">app/src</code> folder you&rsquo;ll find the following structure. The folders below will be commonly found on all microservice, unless stated otherwise:</p>

<ul>
<li>data: data files. This folder is specific to the dataset microservice.</li>
<li>errors: error classes for specific scenarios, which then in turn translate into specific HTTP codes and responses.</li>
<li>models: <code class="prettyprint">mongose</code> models to ease integration with <code class="prettyprint">mongo</code>.</li>
<li>routes: <code class="prettyprint">koa</code> route and request handling definition, as well as middleware.</li>
<li>serializers: <code class="prettyprint">mongoogse</code> model to JSON response serializers.</li>
<li>services: application business logic.</li>
<li>validators: input validators.</li>
<li>app.constants.js: microservice application constants.</li>
<li>app.js: <code class="prettyprint">koa</code> bootstrap, as well as basic error handling and Control Tower registration.</li>
<li>loader.js: convenience file that iterates over the nested content of the <code class="prettyprint">routes</code> folder and loads files.</li>
<li>logger.js: convenience file that configures the logger for ease of use.</li>
</ul>

<h3 id="adding-a-new-endpoint">Adding a new endpoint</h3>

<p>In this section we&rsquo;ll cover how you can add a new endpoint with new functionality to an existing microservice. The aim is not to be a comprehensive guide to cover all cases, but more of a quick entry point into day-to-day actions you may want to perform, which should be complemented by your own learning of how a microservice works - remember that all microservices, despite being structurally similar, have their own custom code and functionality.</p>

<p>To add a new endpoint, here&rsquo;s the short tasklist you have to tackle:</p>

<ul>
<li>Register your route in koa.</li>
<li>Add a handler for that route.</li>
<li>Add middleware for validation, if applicable.</li>
<li>Implement new services, models or serializers to handle your application logic, if applicable.</li>
<li>Add tests for your functionality (you may want to start with this, if TDD is your thing).</li>
<li>Update the Control Tower registration file.</li>
</ul>

<h3 id="register-your-route-in-koa">Register your route in koa</h3>

<p>Route registration is done using the <a href="https://github.com/ZijianHe/koa-router">koa-router</a> library, and can be done in the <code class="prettyprint">app/src/routes/api/v1/dataset.router.js</code> file, usually at the bottom of if:</p>
<pre class="highlight javascript"><code>
<span class="c1">// router object declaration, usually at the top of the file</span>
<span class="kr">const</span> <span class="nx">router</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Router</span><span class="p">({</span>
    <span class="na">prefix</span><span class="p">:</span> <span class="s1">'/dataset'</span><span class="p">,</span>
<span class="p">});</span>

<span class="c1">// routes declaration, usually at the bottom of the file</span>
<span class="nx">router</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'/'</span><span class="p">,</span> <span class="nx">DatasetRouter</span><span class="p">.</span><span class="nx">getAll</span><span class="p">);</span>
<span class="nx">router</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">'/find-by-ids'</span><span class="p">,</span> <span class="nx">DatasetRouter</span><span class="p">.</span><span class="nx">findByIds</span><span class="p">);</span>
<span class="nx">router</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">'/'</span><span class="p">,</span> <span class="nx">validationMiddleware</span><span class="p">,</span> <span class="nx">authorizationMiddleware</span><span class="p">,</span> <span class="nx">authorizationBigQuery</span><span class="p">,</span> <span class="nx">DatasetRouter</span><span class="p">.</span><span class="nx">create</span><span class="p">);</span>
<span class="c1">// router.post('/', validationMiddleware, authorizationMiddleware, authorizationBigQuery, authorizationSubscribable, DatasetRouter.create);</span>
<span class="nx">router</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">'/upload'</span><span class="p">,</span> <span class="nx">validationMiddleware</span><span class="p">,</span> <span class="nx">authorizationMiddleware</span><span class="p">,</span> <span class="nx">DatasetRouter</span><span class="p">.</span><span class="nx">upload</span><span class="p">);</span>
<span class="nx">router</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">'/:dataset/flush'</span><span class="p">,</span> <span class="nx">authorizationMiddleware</span><span class="p">,</span> <span class="nx">DatasetRouter</span><span class="p">.</span><span class="nx">flushDataset</span><span class="p">);</span>
<span class="nx">router</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">'/:dataset/recover'</span><span class="p">,</span> <span class="nx">authorizationRecover</span><span class="p">,</span> <span class="nx">DatasetRouter</span><span class="p">.</span><span class="nx">recover</span><span class="p">);</span>

<span class="nx">router</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'/:dataset'</span><span class="p">,</span> <span class="nx">DatasetRouter</span><span class="p">.</span><span class="nx">get</span><span class="p">);</span>
<span class="nx">router</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'/:dataset/verification'</span><span class="p">,</span> <span class="nx">DatasetRouter</span><span class="p">.</span><span class="nx">verification</span><span class="p">);</span>
<span class="nx">router</span><span class="p">.</span><span class="nx">patch</span><span class="p">(</span><span class="s1">'/:dataset'</span><span class="p">,</span> <span class="nx">validationMiddleware</span><span class="p">,</span> <span class="nx">authorizationMiddleware</span><span class="p">,</span> <span class="nx">DatasetRouter</span><span class="p">.</span><span class="nx">update</span><span class="p">);</span>
<span class="nx">router</span><span class="p">.</span><span class="k">delete</span><span class="p">(</span><span class="s1">'/:dataset'</span><span class="p">,</span> <span class="nx">authorizationMiddleware</span><span class="p">,</span> <span class="nx">DatasetRouter</span><span class="p">.</span><span class="k">delete</span><span class="p">);</span>
<span class="nx">router</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">'/:dataset/clone'</span><span class="p">,</span> <span class="nx">validationMiddleware</span><span class="p">,</span> <span class="nx">authorizationMiddleware</span><span class="p">,</span> <span class="nx">DatasetRouter</span><span class="p">.</span><span class="nx">clone</span><span class="p">);</span>
</code></pre>
<p>In here you&rsquo;ll find the already existing routes. As you can see from the rather explicit syntax, you need to call the method that matches the desired HTTP verb on the <code class="prettyprint">router</code> object, and pass it a variable number of arguments - more on this in the next section. One thing to keep in mind is that all the routes in a file are typically prefixed, as defined in the <code class="prettyprint">router</code> object declaration.</p>

<h2 id="control-tower-integration">Control Tower integration</h2>

<p>While they could technically work as standalone applications, microservices are built from the ground up to work through Control Tower. As such, not only do they lack built-in functionality provided by Control Tower itself (for example, user management), they also need to handle their own integration with Control Tower. Control Tower provides integration libraries for certain languages and frameworks, which you can use to ease development:
- <a href="https://github.com/control-tower/ct-register-microservice-node">nodejs package for Koa</a>
- <a href="https://github.com/control-tower/ct-register-microservice-python-flask">Python module for Flask</a>
- <a href="https://github.com/control-tower/ct-register-microservice-rails">Rails engine</a></p>

<p>These libraries provide 2 basic features that we&rsquo;ll cover in detail in this chapter. You can also use it for reference in case you want to implement a microservice in a different programming language or framework. </p>

<p>We&rsquo;ll use the nodejs library as reference and example in the following sections, as it&rsquo;s the most commonly used language in this API. Other libraries will provided the same underlying functionality, but may have different ways to operate. Refer to each library&rsquo;s specific documentation for more details.</p>

<h3 id="registering-on-control-tower">Registering on Control Tower</h3>

<p>The first feature provided by these libraries, and that a microservice must perform, is registering on Control Tower. Most of the details of this process can be found on <a href="#microservice-registration-process">Control Tower&rsquo;s documentation</a>, which you should read at this point if you haven&rsquo;t already.</p>
<pre class="highlight javascript"><code><span class="c1">// dataset microservice registration example</span>

<span class="kr">const</span> <span class="nx">ctRegisterMicroservice</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'ct-register-microservice-node'</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">Koa</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'koa'</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">logger</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'logger'</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Koa</span><span class="p">();</span>

<span class="kr">const</span> <span class="nx">server</span> <span class="o">=</span> <span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PORT</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">ctRegisterMicroservice</span><span class="p">.</span><span class="nx">register</span><span class="p">({</span>
        <span class="na">info</span><span class="p">:</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'../microservice/register.json'</span><span class="p">),</span>
        <span class="na">swagger</span><span class="p">:</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'../microservice/public-swagger.json'</span><span class="p">),</span>
        <span class="na">mode</span><span class="p">:</span> <span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">CT_REGISTER_MODE</span> <span class="o">&amp;&amp;</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">CT_REGISTER_MODE</span> <span class="o">===</span> <span class="s1">'auto'</span><span class="p">)</span> <span class="p">?</span> <span class="nx">ctRegisterMicroservice</span><span class="p">.</span><span class="nx">MODE_AUTOREGISTER</span> <span class="p">:</span> <span class="nx">ctRegisterMicroservice</span><span class="p">.</span><span class="nx">MODE_NORMAL</span><span class="p">,</span>
        <span class="na">framework</span><span class="p">:</span> <span class="nx">ctRegisterMicroservice</span><span class="p">.</span><span class="nx">KOA2</span><span class="p">,</span>
        <span class="nx">app</span><span class="p">,</span>
        <span class="nx">logger</span><span class="p">,</span>
        <span class="na">name</span><span class="p">:</span> <span class="nx">config</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'service.name'</span><span class="p">),</span>
        <span class="na">ctUrl</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">CT_URL</span><span class="p">,</span>
        <span class="na">url</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">LOCAL_URL</span><span class="p">,</span>
        <span class="na">token</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">CT_TOKEN</span><span class="p">,</span>
        <span class="na">active</span><span class="p">:</span> <span class="kc">true</span>
    <span class="p">}).</span><span class="nx">then</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="p">},</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">logger</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
        <span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">});</span>
</code></pre>
<p>Covering the arguments in detail:</p>

<ul>
<li>info: path to the JSON file that will be sent to Control Tower, containing the details about the endpoints exposed by this microservice.</li>
<li>swagger: path to the Swagger YAML file that will be sent to Control Tower, documenting the public endpoints exposed by this microservice.</li>
<li>mode: if set to <code class="prettyprint">ctRegisterMicroservice.MODE_AUTOREGISTER</code> the Control Tower registration process will be automatically triggered when the Koa application server starts. Otherwise, use <code class="prettyprint">ctRegisterMicroservice.MODE_NORMAL</code> if you want to register manually.</li>
<li>framework: <code class="prettyprint">ctRegisterMicroservice.KOA2</code> or <code class="prettyprint">ctRegisterMicroservice.KOA1</code>, depending on the Koa version your app uses.</li>
<li>app: Koa application instance</li>
<li>logger: <a href="https://github.com/quirkey/node-logger">Logger</a> instance.</li>
<li>name: name of the microservice to be provided to Control Tower as part of the registration process.</li>
<li>ctUrl: Control Tower URL.</li>
<li>url: URL within the internal network through which this microservice can be accessed.</li>
<li>token: Control Tower token to authenticate the registration requests</li>
<li>active: If set to <code class="prettyprint">false</code> the microservice will be registered as disabled (not accessible). You should set this to <code class="prettyprint">true</code> in most cases.</li>
</ul>

<p>This registration call usually takes place right after the microservice&rsquo;s start process has ended, and the corresponding web server is available. Keep in mind that the call above will trigger an HTTP request to Control Tower, which in turn will call the microservice&rsquo;s web server - so make sure the microservice&rsquo;s web server is up and running when you attempt to register it.</p>

<h3 id="requests-to-other-microservices">Requests to other microservices</h3>

<p>Besides contacting Control Tower to register themselves, microservices also need to contact Control Tower to make requests to other microservices. </p>
<pre class="highlight javascript"><code><span class="c1">// Microservice call to another microservice's endpoint</span>
<span class="kr">const</span> <span class="nx">ctRegisterMicroservice</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'ct-register-microservice-node'</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">tags</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'tag1'</span><span class="p">,</span> <span class="s1">'tag2'</span><span class="p">];</span>

<span class="nx">ctRegisterMicroservice</span><span class="p">.</span><span class="nx">requestToMicroservice</span><span class="p">({</span>
    <span class="na">uri</span><span class="p">:</span> <span class="s2">`/graph/dataset/</span><span class="p">${</span><span class="nx">id</span><span class="p">}</span><span class="s2">/associate`</span><span class="p">,</span>
    <span class="na">method</span><span class="p">:</span> <span class="s1">'POST'</span><span class="p">,</span>
    <span class="na">json</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="na">body</span><span class="p">:</span> <span class="p">{</span>
        <span class="nx">tags</span>
    <span class="p">}</span>
<span class="p">});</span>
</code></pre>
<p>In this example, the dataset microservice makes a call to the <code class="prettyprint">/graph/dataset/&lt;id&gt;/associate</code> endpoint to tag a dataset with the given tag list. This endpoint is implemented by the Graph microservice, but the request is actually handled by Control Tower. Taking a deeper look at the code that implements the call above, we learn a few things:</p>
<pre class="highlight javascript"><code><span class="c1">// Implementation of call to another microservice</span>

<span class="nx">requestToMicroservice</span><span class="p">(</span><span class="nx">config</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">logger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">'Adding authentication header '</span><span class="p">);</span>
    <span class="k">try</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nx">version</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">API_VERSION</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">version</span> <span class="o">=</span> <span class="s2">`/</span><span class="p">${</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">API_VERSION</span><span class="p">}</span><span class="s2">`</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">version</span> <span class="o">===</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">version</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nx">config</span><span class="p">.</span><span class="nx">headers</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">headers</span> <span class="o">||</span> <span class="p">{},</span> <span class="p">{</span> <span class="na">authentication</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">token</span> <span class="p">});</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">application</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">config</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">app_key</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span> <span class="na">application</span><span class="p">:</span> <span class="nx">config</span><span class="p">.</span><span class="nx">application</span> <span class="p">});</span>
        <span class="p">}</span>
        <span class="nx">config</span><span class="p">.</span><span class="nx">uri</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">ctUrl</span> <span class="o">+</span> <span class="nx">version</span> <span class="o">+</span> <span class="nx">config</span><span class="p">.</span><span class="nx">uri</span><span class="p">;</span>
        <span class="k">return</span> <span class="nx">requestPromise</span><span class="p">(</span><span class="nx">config</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">logger</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">'Error to doing request'</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span>
        <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">}</span>
</code></pre>
<p>As explained above, although the call is ultimately to another microservice, the request is sent to Control Tower, who is then responsible for issuing another internal request to the destination microservice, getting the reply from that call and passing it on to the microservice that initiated the process.</p>

<p>Another thing you&rsquo;ll notice is that this call depends on preexisting configuration stored in the <code class="prettyprint">this.options</code> property. These configuration options are stored within the object during the Control Tower registration process, meaning you should not attempt to make a call to another microservice unless you have previously registered your microservice on Control Tower. Keep in mind that this is a restriction of this particular integration library, and not of Control Tower itself - a different implementation could do internal requests to microservices through Control Tower without being registered as a microservice.</p>

<p>In some scenarios, while developing, it&rsquo;s not practical to run all the microservices your logic depend on on your development computer. The <a href="#writing-end-to-end-tests">Writing end-to-end tests</a> section has some details about writing tests for your code, including how you can mock such calls, so you don&rsquo;t have to run the actual dependencies.</p>

<h2 id="docker">Docker</h2>

<p>When deployed in a production environment, microservices will run in a <a href="https://www.docker.com/">Docker</a> container. As a microservice developer, you should include in your microservice the necessary configuration to run your application inside a container. This is done using a Dockerfile, and you can use the <a href="https://github.com/resource-watch/dataset/blob/develop/Dockerfile">Dataset microservice&rsquo;s Dockerfile</a> as an example of how one of these files looks like for a nodejs based microservice.</p>

<p>Its worth noting that these container are set up in a way that allows using them to both run the microservice itself, or their tests. This will be useful further ahead when we review the testing approach you should use when writing microservices.</p>

<h2 id="data-layer">Data layer</h2>

<p>Many microservices require the ability to store data to perform their function. The RW API has several data storage tools available to you, in case you need to store information to run your service.</p>

<p><strong>Warning</strong>: microservices run on ephemeral containers managed by Kubernetes, and often in multiple parallel instances, so do not rely on storing data on the filesystem, unless you know there&rsquo;s something like a <a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/">Kubernetes&rsquo; persistent volume</a> to back it up.</p>

<p>When accessing these tools, there are a few things you should keep in mind:</p>

<ul>
<li>Isolation is not guaranteed, meaning your microservice will have theoretical access to other microservice&rsquo;s data, and other microservices may access your data.</li>
<li>Despite having access to it, you should not manipulate other microservice&rsquo;s data directly at the data layer, unless there&rsquo;s a clear agreement between the involved microservices.</li>
<li>It&rsquo;s up to you to ensure logic level isolation of your data - for example, if you rely on an relational database, be sure to use a unique database name.</li>
<li>Access to the data layer is only available within the RW API cluster, which is why not all data storage tools have authentication enabled.</li>
</ul>

<p>Currently, the following data storage tools are available on the RW API cluster:</p>

<h3 id="mongodb-v3-6">MongoDB v3.6</h3>

<p><a href="https://www.mongodb.com/">MongoDB</a> is the most frequently used data storage tool, as it supports schema-less document storage, thus making it easy to setup and run. When using MongoDB, be sure to give your collection an unique name, to avoid conflicts</p>

<p>To see an example of how to use MongoDB on a real-world microservice, check out the <a href="https://github.com/resource-watch/dataset/">Dataset microservice</a>.</p>

<h3 id="postgres-v9-6">Postgres v9.6</h3>

<p>Use <a href="https://www.postgresql.org/">Postgres</a> if your application needs a relational database. Unlike other data storage tools, Postgres access to individual microservices is granted on a per-database basis.</p>

<p>To see an example of how to use Postgres on a real-world microservice, check out the <a href="https://github.com/resource-watch/resource-watch-manager/">Resource watch manager microservice</a> (written in Ruby on Rails).</p>

<h3 id="elasticsearch-v5-5">Elasticsearch v5.5</h3>

<p>Use <a href="https://www.elastic.co/">Elasticsearch</a> for search optimization or heterogeneous data storage with quick access. The current setup also includes <a href="https://github.com/NLPchina/elasticsearch-sql">a 3rd party plugin for SQL support on ES 5</a>.</p>

<p>To see an example of how to use Elasticsearch on a real-world microservice, check out the <a href="https://github.com/resource-watch/document-adapter/">Document dataset adapter microservice</a>.</p>

<h3 id="redis-v5-0">Redis v5.0</h3>

<p><a href="https://redis.io/">Redis</a> is an in-memory data storage tool, and can also be used as a <a href="https://en.wikipedia.org/wiki/Publish%E2%80%93subscribe_pattern">pub-sub</a> messaging tool.</p>

<p>You can learn how to use Redis in your applications by looking at the code of the <a href="https://github.com/gfw-api/gfw-subscription-api">Subscriptions microservice</a>.</p>

<h3 id="neo4j-v2-0">Neo4J v2.0</h3>

<p><a href="https://neo4j.com/">Neo4J</a> is a graph database used by <a href="https://github.com/resource-watch/graph-client/">Graph microservice</a> to build complex associations between different RW API resources.</p>

<h3 id="rabbitmq-v3-7">RabbitMQ v3.7</h3>

<p><a href="https://www.rabbitmq.com/">RabbitMQ</a> is a message broker service, which is particularly useful when handling long, asynchronous operations. You can see an example of its usage on the <a href="https://github.com/resource-watch/doc-executor">Document microservice - Executor submodule</a> code base.</p>

<h3 id="cloud-services">Cloud services</h3>

<p>Some microservices have data storage needs that are not covered by the applications described here (for example, file storage). In those scenarios, it&rsquo;s common to use cloud services (like AWS S3, for example), but do reach out to the broader RW API development team before implementing your solution.</p>

<h2 id="http-caching">HTTP caching</h2>

<p>The RW API has a system-wide HTTP cache that you may use to cache your requests, improving scalability and response times. This cache is based on <a href="https://www.fastly.com/">Fastly</a>, and you can browse its documentation if you are looking for a specific detail on its behavior. For most common use cases, you just need to keep in mind the following:</p>

<ul>
<li>Only responses with codes 200, 203, 300 and 410 are cached, and the default cache TTL is 3 days.</li>
<li>GET responses for <code class="prettyprint">/auth</code> endpoints are never cached.</li>
<li>GET responses for <code class="prettyprint">/query</code> or <code class="prettyprint">/fields</code> endpoints are cached for 2 days.</li>
<li>Your microservice can use the <code class="prettyprint">cache</code> response header to tag a cache entry. This, in itself, has no functional impact. Example <a href="https://github.com/resource-watch/dataset/blob/47ad8b9509b97803d7f484549908e72ecaa98467/app/src/routes/api/v1/dataset.router.js#L396">here</a>.</li>
<li>Your microservice can use the <code class="prettyprint">uncache</code> header to purge cache entries matching a given tag, as set in the previous point. Example <a href="https://github.com/resource-watch/dataset/blob/47ad8b9509b97803d7f484549908e72ecaa98467/app/src/routes/api/v1/dataset.router.js#L462">here</a>.</li>
</ul>

<h2 id="logging">Logging</h2>

<p>An important part of microservice operation is logging events as it processes requests. Many errors are only triggered during staging and production server execution, and without proper logging, there isn&rsquo;t a way to identify how it can be reproduced, so it can then be fixed.</p>

<p>Common development languages often come with either built-in or 3rd party logging libraries than make logging easier to handle. Current nodejs microservices use <a href="https://github.com/trentm/node-bunyan">Bunyan</a> to manage logs, which eases managing log destinations (stdout, file, etc) and log levels. Other libraries, for nodejs and other languages, offer similar functionality.</p>

<p>For microservice staging and production logs, the output channels should be <code class="prettyprint">stdout</code> and <code class="prettyprint">stderr</code>, the standard output streams you&rsquo;ll find on most OSs. When live, these, will seamlessly integrate with the infrastructure to which microservices will be deployed, and will allow for cluster-wide logging. </p>
<pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">logger</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'logger'</span><span class="p">);</span>

<span class="nx">logger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">'Validating Dataset Update'</span><span class="p">);</span>
</code></pre>
<p>The example above logs that the validation process for input data associated with a dataset updated has been started. You&rsquo;ll notice that the <code class="prettyprint">info()</code> function is called - this sets the logging level for this message. While different logging tools implement different strategies to differentiate logs, most microservices uses these 4 levels:</p>

<ul>
<li><code class="prettyprint">debug</code>: use this whenever anything happens, that may or may not be relevant to have logged on a daily basis, but rather as a opt-in development and debug tool.</li>
<li><code class="prettyprint">info</code>: use this for high-level expected actions and output that you&rsquo;d need to have available to you in case you need to investigate a production issue.</li>
<li><code class="prettyprint">warn</code>: use this for situations where something unexpected happened, but that may not necessarily be irregular flows - for example, user originated errors.</li>
<li><code class="prettyprint">error</code>: use this when the application failed and is no longer able to recover, or when an server-side error occurs.</li>
</ul>

<p>A common issue some developers have concerns logging errors. It&rsquo;s not uncommon to find microservices where all types of errors generate a <code class="prettyprint">error</code> log entry. However, this actually produces a lot of noise, and make it hard to debug. Consider the following two scenarios when attempting to load a dataset by id:</p>

<ul>
<li>The dataset microservice queries the database, and the database cannot find a dataset matching that id, and the microservice returns a 404 HTTP response.</li>
<li>The dataset microservice queries the database, but the database is offline for whatever reason, and the microservice returns a 500 HTTP response.</li>
</ul>

<p>Both cases are, indeed, errors. However, the first one is not an application error - the microservice behaved as it should. In this scenario, logging this event should not involve an <code class="prettyprint">error</code> level event, as nothing unexpected, from the application&rsquo;s point of view, happened: a user asked for something that does not exist, and the microservice handled that as it should.</p>

<p>On the second case, however, something really unexpected did happen - the microservice could not contact the database. This is an application level error, as we assume that our databases are always available for to microservices. This is an example scenario where a <code class="prettyprint">error</code> logging line should be generated. Or, putting it in another way, only use <code class="prettyprint">errors</code> logging for situations where a RW API developer should look into it.</p>

<p>Another best practice we recommend for log management is using an application-wide configuration value to define the logging level. This is prove extremely useful when you switch from your local development environment (where you may prefer the <code class="prettyprint">debug</code> logging level for maximum detail) to production (where <code class="prettyprint">warn</code> or <code class="prettyprint">error</code> may be more reasonable). </p>

<p>When using Bunyan, logging levels are set <a href="https://github.com/resource-watch/dataset/blob/5d4b6d1a3b243f5ba985b444633c0f6acf78b35d/app/src/logger.js#L7">per stream</a>. Many microservices integrate the <a href="https://www.npmjs.com/package/config">Config</a> library at this stage, allowing you to have different values for <a href="https://github.com/resource-watch/dataset/blob/25ab6b6ac7b1c4618b3d4ae1690957b256bafca8/config/prod.json#L4">production</a>, <a href="https://github.com/resource-watch/dataset/blob/685a799f79f2441a129e4cf5cfaf3ed06ace5546/config/staging.json#L4">staging</a> or other environments. Config also allows you to <a href="https://github.com/resource-watch/dataset/blob/34d4b00fe06bd6d7c9b1dd25e043da4e820db653/config/custom-environment-variables.json#L12">override selected values with a environment variable</a>, typically <code class="prettyprint">LOGGER_LEVEL</code>, which you may use, for example, to temporarily override the logging level on a particular environment without changing the predefined default values. </p>

<p>If you want to access your logging output for a microservice that&rsquo;s already deployed on either staging or production, you&rsquo;ll need access to <code class="prettyprint">kubernetes</code> logging UI or CLI.</p>

<h2 id="testing">Testing</h2>

<p>Testing code is important. And, as the developer of a RW API microservice, it&rsquo;s your responsibility to ensure that your code is bug free and easily extendable in the future. That means it should ship with a set of tests that can ensure, now and in the future, that it does what it&rsquo;s supposed to do. And the best way to do that is through testing.</p>

<p>If you are developing a new microservice or endpoint, it&rsquo;s expected that you provide a complete test suit for your code. In many cases, existing microservices will be a valuable source of examples you can copy and adapt to your needs. On occasion, you&rsquo;ll need to changes to endpoints that are not yet covered by tests. In those scenarios, we ask that add at least the tests to cover your modification. If you are feeling generous, and want to add tests that cover the endpoint&rsquo;s full functionality, you&rsquo;ll have our gratitude - test coverage for the RW API&rsquo;s endpoints is a work in progress, and not all endpoints have been reached just yet.</p>

<h3 id="writing-end-to-end-tests">Writing end-to-end tests</h3>

<p>Most microservices rely, to varying degrees, on end-to-end tests. In the context of an HTTP based microservice, this means that tests are responsible for issuing an HTTP request to a running instance of your microservice, getting the response and validating its content. Tests should also handle things like mocking resources and isolation from outside world - we&rsquo;ll get to these in a moment.</p>

<blockquote>
<p>Example of a test from the dataset microservice</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">it</span><span class="p">(</span><span class="s1">'Create a JSON dataset with data in the body should be successful'</span><span class="p">,</span> <span class="nx">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">timestamp</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">();</span>
    <span class="kr">const</span> <span class="nx">dataset</span> <span class="o">=</span> <span class="p">{</span>
        <span class="na">name</span><span class="p">:</span> <span class="s2">`JSON Dataset - </span><span class="p">${</span><span class="nx">timestamp</span><span class="p">.</span><span class="nx">getTime</span><span class="p">()}</span><span class="s2">`</span><span class="p">,</span>
        <span class="na">application</span><span class="p">:</span> <span class="p">[</span><span class="s1">'forest-atlas'</span><span class="p">,</span> <span class="s1">'rw'</span><span class="p">],</span>
        <span class="na">applicationConfig</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">'forest-atlas'</span><span class="p">:</span> <span class="p">{</span>
                <span class="na">foo</span><span class="p">:</span> <span class="s1">'bar'</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="na">rw</span><span class="p">:</span> <span class="p">{</span>
                <span class="na">foo</span><span class="p">:</span> <span class="s1">'bar'</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="na">connectorType</span><span class="p">:</span> <span class="s1">'document'</span><span class="p">,</span>
        <span class="na">env</span><span class="p">:</span> <span class="s1">'production'</span><span class="p">,</span>
        <span class="na">provider</span><span class="p">:</span> <span class="s1">'json'</span><span class="p">,</span>
        <span class="na">dataPath</span><span class="p">:</span> <span class="s1">'data'</span><span class="p">,</span>
        <span class="na">dataLastUpdated</span><span class="p">:</span> <span class="nx">timestamp</span><span class="p">.</span><span class="nx">toISOString</span><span class="p">(),</span>
        <span class="na">data</span><span class="p">:</span> <span class="p">{</span>
            <span class="na">data</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="na">a</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="na">b</span><span class="p">:</span> <span class="mi">2</span>
                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="na">a</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
                    <span class="na">b</span><span class="p">:</span> <span class="mi">1</span>
                <span class="p">},</span>
            <span class="p">]</span>
        <span class="p">}</span>
    <span class="p">};</span>

    <span class="nx">nock</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">CT_URL</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">'/v1/doc-datasets/json'</span><span class="p">,</span> <span class="p">(</span><span class="nx">request</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="nx">request</span><span class="p">.</span><span class="nx">should</span><span class="p">.</span><span class="nx">have</span><span class="p">.</span><span class="nx">property</span><span class="p">(</span><span class="s1">'connector'</span><span class="p">).</span><span class="nx">and</span><span class="p">.</span><span class="nx">be</span><span class="p">.</span><span class="nx">an</span><span class="p">(</span><span class="s1">'object'</span><span class="p">);</span>
            <span class="kr">const</span> <span class="nx">requestDataset</span> <span class="o">=</span> <span class="nx">request</span><span class="p">.</span><span class="nx">connector</span><span class="p">;</span>

            <span class="nx">requestDataset</span><span class="p">.</span><span class="nx">should</span><span class="p">.</span><span class="nx">have</span><span class="p">.</span><span class="nx">property</span><span class="p">(</span><span class="s1">'name'</span><span class="p">).</span><span class="nx">and</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">dataset</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>
            <span class="nx">requestDataset</span><span class="p">.</span><span class="nx">should</span><span class="p">.</span><span class="nx">have</span><span class="p">.</span><span class="nx">property</span><span class="p">(</span><span class="s1">'connectorType'</span><span class="p">).</span><span class="nx">and</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">dataset</span><span class="p">.</span><span class="nx">connectorType</span><span class="p">);</span>
            <span class="nx">requestDataset</span><span class="p">.</span><span class="nx">should</span><span class="p">.</span><span class="nx">have</span><span class="p">.</span><span class="nx">property</span><span class="p">(</span><span class="s1">'application'</span><span class="p">).</span><span class="nx">and</span><span class="p">.</span><span class="nx">eql</span><span class="p">(</span><span class="nx">dataset</span><span class="p">.</span><span class="nx">application</span><span class="p">);</span>
            <span class="nx">requestDataset</span><span class="p">.</span><span class="nx">should</span><span class="p">.</span><span class="nx">have</span><span class="p">.</span><span class="nx">property</span><span class="p">(</span><span class="s1">'data'</span><span class="p">).</span><span class="nx">and</span><span class="p">.</span><span class="nx">deep</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">dataset</span><span class="p">.</span><span class="nx">data</span><span class="p">);</span>
            <span class="nx">requestDataset</span><span class="p">.</span><span class="nx">should</span><span class="p">.</span><span class="nx">have</span><span class="p">.</span><span class="nx">property</span><span class="p">(</span><span class="s1">'sources'</span><span class="p">).</span><span class="nx">and</span><span class="p">.</span><span class="nx">eql</span><span class="p">([]);</span>
            <span class="nx">requestDataset</span><span class="p">.</span><span class="nx">should</span><span class="p">.</span><span class="nx">not</span><span class="p">.</span><span class="nx">have</span><span class="p">.</span><span class="nx">property</span><span class="p">(</span><span class="s1">'connectorUrl'</span><span class="p">);</span>

            <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">})</span>
        <span class="p">.</span><span class="nx">reply</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="p">{</span>
            <span class="na">status</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
            <span class="na">detail</span><span class="p">:</span> <span class="s1">'Ok'</span>
        <span class="p">});</span>

    <span class="kr">const</span> <span class="nx">response</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">requester</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s2">`/api/v1/dataset`</span><span class="p">).</span><span class="nx">send</span><span class="p">({</span>
        <span class="nx">dataset</span><span class="p">,</span>
        <span class="na">loggedUser</span><span class="p">:</span> <span class="nx">USERS</span><span class="p">.</span><span class="nx">ADMIN</span>
    <span class="p">});</span>
    <span class="kr">const</span> <span class="nx">createdDataset</span> <span class="o">=</span> <span class="nx">deserializeDataset</span><span class="p">(</span><span class="nx">response</span><span class="p">);</span>

    <span class="nx">response</span><span class="p">.</span><span class="nx">status</span><span class="p">.</span><span class="nx">should</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
    <span class="nx">response</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">should</span><span class="p">.</span><span class="nx">have</span><span class="p">.</span><span class="nx">property</span><span class="p">(</span><span class="s1">'data'</span><span class="p">).</span><span class="nx">and</span><span class="p">.</span><span class="nx">be</span><span class="p">.</span><span class="nx">an</span><span class="p">(</span><span class="s1">'object'</span><span class="p">);</span>
    <span class="nx">createdDataset</span><span class="p">.</span><span class="nx">should</span><span class="p">.</span><span class="nx">have</span><span class="p">.</span><span class="nx">property</span><span class="p">(</span><span class="s1">'name'</span><span class="p">).</span><span class="nx">and</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="s2">`JSON Dataset - </span><span class="p">${</span><span class="nx">timestamp</span><span class="p">.</span><span class="nx">getTime</span><span class="p">()}</span><span class="s2">`</span><span class="p">);</span>
    <span class="nx">createdDataset</span><span class="p">.</span><span class="nx">should</span><span class="p">.</span><span class="nx">have</span><span class="p">.</span><span class="nx">property</span><span class="p">(</span><span class="s1">'connectorType'</span><span class="p">).</span><span class="nx">and</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="s1">'document'</span><span class="p">);</span>
    <span class="nx">createdDataset</span><span class="p">.</span><span class="nx">should</span><span class="p">.</span><span class="nx">have</span><span class="p">.</span><span class="nx">property</span><span class="p">(</span><span class="s1">'provider'</span><span class="p">).</span><span class="nx">and</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="s1">'json'</span><span class="p">);</span>
    <span class="nx">createdDataset</span><span class="p">.</span><span class="nx">should</span><span class="p">.</span><span class="nx">have</span><span class="p">.</span><span class="nx">property</span><span class="p">(</span><span class="s1">'connectorUrl'</span><span class="p">).</span><span class="nx">and</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
    <span class="nx">createdDataset</span><span class="p">.</span><span class="nx">should</span><span class="p">.</span><span class="nx">have</span><span class="p">.</span><span class="nx">property</span><span class="p">(</span><span class="s1">'tableName'</span><span class="p">);</span>
    <span class="nx">createdDataset</span><span class="p">.</span><span class="nx">should</span><span class="p">.</span><span class="nx">have</span><span class="p">.</span><span class="nx">property</span><span class="p">(</span><span class="s1">'userId'</span><span class="p">).</span><span class="nx">and</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">USERS</span><span class="p">.</span><span class="nx">ADMIN</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
    <span class="nx">createdDataset</span><span class="p">.</span><span class="nx">should</span><span class="p">.</span><span class="nx">have</span><span class="p">.</span><span class="nx">property</span><span class="p">(</span><span class="s1">'status'</span><span class="p">).</span><span class="nx">and</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="s1">'pending'</span><span class="p">);</span>
    <span class="nx">createdDataset</span><span class="p">.</span><span class="nx">should</span><span class="p">.</span><span class="nx">have</span><span class="p">.</span><span class="nx">property</span><span class="p">(</span><span class="s1">'overwrite'</span><span class="p">).</span><span class="nx">and</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
    <span class="nx">createdDataset</span><span class="p">.</span><span class="nx">should</span><span class="p">.</span><span class="nx">have</span><span class="p">.</span><span class="nx">property</span><span class="p">(</span><span class="s1">'applicationConfig'</span><span class="p">).</span><span class="nx">and</span><span class="p">.</span><span class="nx">deep</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">dataset</span><span class="p">.</span><span class="nx">applicationConfig</span><span class="p">);</span>
    <span class="nx">createdDataset</span><span class="p">.</span><span class="nx">should</span><span class="p">.</span><span class="nx">have</span><span class="p">.</span><span class="nx">property</span><span class="p">(</span><span class="s1">'dataLastUpdated'</span><span class="p">).</span><span class="nx">and</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">timestamp</span><span class="p">.</span><span class="nx">toISOString</span><span class="p">());</span>
    <span class="nx">createdDataset</span><span class="p">.</span><span class="nx">legend</span><span class="p">.</span><span class="nx">should</span><span class="p">.</span><span class="nx">be</span><span class="p">.</span><span class="nx">an</span><span class="p">.</span><span class="nx">instanceOf</span><span class="p">(</span><span class="nb">Object</span><span class="p">);</span>
    <span class="nx">createdDataset</span><span class="p">.</span><span class="nx">clonedHost</span><span class="p">.</span><span class="nx">should</span><span class="p">.</span><span class="nx">be</span><span class="p">.</span><span class="nx">an</span><span class="p">.</span><span class="nx">instanceOf</span><span class="p">(</span><span class="nb">Object</span><span class="p">);</span>
<span class="p">});</span>
</code></pre>
<p>Current nodejs based microservices rely on <a href="https://www.chaijs.com/">Chai</a> and <a href="https://mochajs.org/">Mocha</a> as testing libraries, and this code example shows one of the tests that validate the dataset creation process. The code block is relatively large, but the logic is simple:</p>

<ul>
<li>We craft a JSON object with the content of the HTTP POST body</li>
<li>As this endpoint needs to make a call to another microservice (through Control Tower), we use <a href="https://github.com/nock/nock">Nock</a> to mock that POST request to the <code class="prettyprint">/v1/doc-datasets/json</code> endpoint. This way, your tests won&rsquo;t require actual running instances of Control Tower or other microservices to run.</li>
<li>We send the our previously crafted POST request to a running instance of our dataset microservice, along with a <code class="prettyprint">loggedUser</code> spoof data.</li>
<li>We get the HTTP response, process it for easier handling, and proceed to validate that it&rsquo;s content is as expected.</li>
</ul>

<p>Different microservices and endpoint will have different requirements when it comes to testing, but the great majority of endpoints can be tested using simple variations of these steps. There are some additional considerations you should take into account when testing:</p>

<ul>
<li>The example above creates an actual dataset, meaning a MongoDB (or equivalent mocks) need to exist. For MongoDB specifically, our approach so far has been to use a real MongoDB instance, and running the tests on a separate database (´dataset-tests´ for example), aiming for isolation. Other microservices (for example, those relying on Elasticsearch) use mocks instead. Mocking usually leads to faster execution times, but can be troublesome to properly code. Use whichever alternative is best for you, and refer to the <a href="#data-layer">Data layer</a> section for examples of microservices that use (and test with) different tools.</li>
<li>Nock has a <a href="https://github.com/nock/nock#enabledisable-real-http-requests">feature that blocks all HTTP requests</a>, which is useful to ensure your code or tests are not relying on an external service without you being aware - just be sure to whitelist your own IP, otherwise the HTTP call your test makes to your microservice will fail too.</li>
<li>Tests must be idempotent, and execute without assuming order. For example, running a test that first tests an insert, and then using the inserted element to test a delete would be a bad practice. Instead, your insert test should clean up its data once it&rsquo;s done, and the delete test should prepopulate the database before actually trying to delete it. A corollary of this is that you should be able to run your tests multiple times, back-to-back, without that affecting the results.</li>
</ul>

<h3 id="test-coverage-metrics">Test coverage metrics</h3>

<p>While not required, most microservices use <a href="https://en.wikipedia.org/wiki/Code_coverage">code coverage</a> tools to evaluate how much of your code base is actually being checked when the test suite is executed. Nodejs based microservices frequently use <a href="https://www.npmjs.com/package/nyc">NYC</a> and <a href="https://istanbul.js.org/">Istanbul</a> for this purpose, in case you are looking for a recommendation.</p>

<h3 id="running-your-tests-using-docker-compose">Running your tests using docker compose</h3>

<p>The previous section covers an example of how a test looks like. Depending on your microservice technology stack, you have different ways of running your tests - in the case of the Dataset microservice, tests are executed using <a href="https://yarnpkg.com/">yarn</a>. </p>

<p>However, to standardise test execution, you should also create a <a href="https://docs.docker.com/compose/">docker compose</a> file that runs your tests (and their dependencies). This docker compose configuration should use the <a href="#docker">existing docker file</a> set up previously, unless that&rsquo;s not possible.</p>

<p>Here&rsquo;s an example of <a href="https://github.com/resource-watch/dataset/blob/ab23e379362680e9899ac8f191589988f0b7c1cd/docker-compose-test.yml">one of these files</a>. These will be particularly useful down the line, but also convenient for running tests locally.</p>

<p>For convenience, microservices commonly have a <a href="https://github.com/resource-watch/dataset/blob/ab23e37936/dataset.sh#L8">one line CLI command</a> that allows running tests using the docker compose configuration you provide. These are particularly useful for other developers to run your tests without having to manually set up the associated dependencies.</p>

<h3 id="ci-cd-travis-and-code-climate">CI/CD, Travis and Code Climate</h3>

<p>Assuming you are hosting your microservice code on a service like Github, then you may benefit from its integration with <a href="https://en.wikipedia.org/wiki/CI/CD">CI/CD</a> tools. There are multiple options in this space, and they mostly offer the same core functionality, but our preference so far has been to use <a href="https://travis-ci.org/">Travis</a>. In a nutshell, you can configure Travis to run your tests every time you push a new commit to a Github pull request. Tests will run on Travis&rsquo; servers, and if they fail, you will get a message on your pull request warning you about this.</p>

<p>For full details on Travis and its features, how to configure it, what alternatives are there, and their pros and cons, please refer to your favourite search engine. If you are just want the basic, &ldquo;it just works&rdquo; configuration, <a href="https://github.com/resource-watch/dataset/blob/cd55ff83695266ffae58471569fc3c16b2f1adf2/.travis.yml#L10">this file from the Dataset microservice</a> will have most of what you&rsquo;ll need.</p>

<p>Apart from running your tests, Travis also integrates with a service called <a href="https://codeclimate.com/">Code Climate</a> which analyses your code and looks for potentially problematic bits and suggests you fix them. More often than not, we just rely on another functionality offered by Code Climate - <a href="https://en.wikipedia.org/wiki/Code_coverage">code coverage</a>. This allows you to easily monitor how your pull request influences code coverage - for example, you can set up an alarm that warns you in case your pull request decreases your code coverage, which may indicate that you added more code than you tested.</p>

<p>Most microservices will display a test status and code coverage badges on their README, as a way to display if the tests are passing, and a rough estimation of how broad the test coverage is.</p>

<h3 id="smoke-testing">Smoke testing</h3>

<p>Besides the test tools covered above, which are used to validate that your code changes work as designed, there is also a smoke test tool in place, that periodically issues a request to selected RW API endpoints and validates that the response match an expected preconfigured value. These tests are not used to validate functionality, but rather availability - if something goes wrong, a human is notified that the RW API is not working as it should, and that this is potentially affecting users. </p>

<p>If you believe your microservice implements a mission-critical endpoint that would merit one of these tests, please reach out to the RW API team.</p>

<h2 id="deploying-your-microservice">Deploying your microservice</h2>

<h3 id="jenkins">Jenkins</h3>

<p>Microservice deployment to the Kubernetes clusters is done using <a href="https://www.jenkins.io/">Jenkins</a>. The actual deployment process is configurable using a <a href="https://github.com/resource-watch/dataset/blob/develop/Jenkinsfile">Jenkinsfile</a> script written in <a href="https://groovy-lang.org/">Groovy</a>. Most microservices use the same file, as the logic in it is flexible enough to accommodate most scenarios.</p>

<p>In a nutshell, this Jenkinsfile will:</p>

<ul>
<li>Build a docker image using the Docker file contained in your microservice.</li>
<li>Uses the included docker compose configuration to run your tests. If the tests fail, the process is aborted at this stage</li>
<li>Push the generated docker image to <a href="https://hub.docker.com/">dockerhub</a></li>
<li>Depending on the git branch, the following actions will take place:

<ul>
<li>If deploying from the <code class="prettyprint">develop</code> branch, it will push the docker image to the staging kubernetes cluster </li>
<li>If deploying from the <code class="prettyprint">master</code> branch, you will get a confirmation input. If you confirm, it will push the docker image to the production kubernetes cluster </li>
<li>Any other branches are ignored.</li>
</ul></li>
</ul>

<p>At the beginning of each deploy process, you will also see an confirmation input that, if accepted, will redeploy the kubernetes configuration contained in the microservice code repository to the respective kubernetes cluster: <code class="prettyprint">develop</code> branch to the staging cluster, <code class="prettyprint">master</code> branch to the production cluster.</p>

<p>One thing worth noting is that the docker images generated using this method are publicly available on dockerhub. Be careful not to store any sensitive data in them, as it will be available to anyone.</p>

<h3 id="kubernetes-configuration">Kubernetes configuration</h3>

<p>Most microservice have a <a href="https://github.com/resource-watch/dataset/tree/develop/k8s">Kubernetes configuration folder</a>, typically containing 3 folders:</p>

<ul>
<li><code class="prettyprint">production</code> contains files that will be applied when deploying the <code class="prettyprint">master</code> branch to the production cluster</li>
<li><code class="prettyprint">staging</code> contains files that will be applied when deploying the <code class="prettyprint">develop</code> branch to the production cluster</li>
<li><code class="prettyprint">services</code> contains files that will be applied when deploying either branches to their respective cluster.</li>
</ul>

<p>Note that these settings are only applied if you opt in to it, by interacting with the input request that is displayed on Jenkins at the very beginning of the deployment process.</p>

<h2 id="documentation">Documentation</h2>

<h3 id="readme">README</h3>

<p>Here are some &lsquo;do&rsquo; and &#39;do not&rsquo; you should take into account when writing the README.md for your microservice.</p>

<p>Do:</p>

<ul>
<li>Add the name of your microservice, along with a high level, short description of what it does.</li>
<li>Identify the technical dependencies. This should include:

<ul>
<li>Programming language</li>
<li>Main framework or language-specific tools used</li>
<li>Data layer dependencies or other applications, including version numbers</li>
<li>Dependencies on other microservices</li>
</ul></li>
<li>Describe how to get your microservice up and running for development purposes (at least for the operating system you are currently using, but you get extra &ldquo;thank you&quot;s if you add details for other OSs)</li>
<li>Describe how to run your tests</li>
<li>Describe if and which configuration variables exist, and their behavior.</li>
<li>Document implementation details, software development architectural decisions, etc</li>
<li>Use English.</li>
</ul>

<p>Do not:</p>

<ul>
<li>Document in detail how to set up dependencies on 3rd party applications (for example, don&rsquo;t provide installation instruction for a database server, just mention it&rsquo;s a dependency, and assume your fellow developer will figure out how to set it up on their system).</li>
<li>Include a license text - you may mention it, but add the actual text on a separate file, to keep the README file concise.</li>
<li>Assume the reader has vast experience in developing for the RW API, in the language your microservice is coded on, or using its dependencies or libraries</li>
<li>Document endpoint behavior - that goes elsewhere.</li>
</ul>

<p>Overall, the README should be targeted at developers that may need to run, test and debug your code.</p>

<h3 id="functional-documentation">Functional documentation</h3>

<p>Documentation describing the business logic implemented by your microservice should go in the <a href="/">RW API Documentation</a> page. The documentation is available <a href="https://github.com/resource-watch/doc-api/">on this Github repository</a> and its README includes instructions on how to use it and contribute.</p>

<p>Documentation is a key component of a successful API, so when altering public-facing behavior on the RW API, you must update the documentation accordingly, so that RW API users out there can be aware of the changes you made.</p>

<h2 id="code-styling">Code styling</h2>

<p>As a way to help RW API developers collaborate, most microservices include a <a href="https://en.wikipedia.org/wiki/Lint_(software)">linter</a> tool and ruleset to promote, as much as possible, a common set of rules for the way code is structured.</p>

<p>For microservices written in nodejs, this is achieved using <a href="https://eslint.org/">Eslint</a> with <a href="https://github.com/resource-watch/dataset/blob/develop/.eslintrc.yml">this configuration file</a>.</p>

<p>For ruby-based microservices, you can use <a href="https://github.com/rubocop-hq/rubocop">Rubocop</a> along with <a href="https://github.com/resource-watch/resource-watch-manager/blob/develop/.rubocop.yml">this configuration file</a>.</p>

<p>Most microservices will also include a <a href="https://github.com/resource-watch/dataset/blob/develop/.editorconfig">.editorconfig</a> file - you can learn more about there <a href="https://editorconfig.org/">here</a>.</p>

          <h1 id="endpoints">Endpoints</h1>

<p>This section of the documentation refers to endpoints that can only be used for the purposes of development. These endpoints can only be called by other micro services via Control Tower.</p>

<h2 id="finding-users-by-ids">Finding users by ids</h2>

<p>To retrieve the information of multiple users by ids, use the <code class="prettyprint">/auth/user/find-by-ids</code> endpoint.</p>

<p>This endpoint requires authentication, and can only be called from another micro service.</p>
<pre class="highlight shell"><code><span class="c"># retrieve info for multiple users with the given ids</span>
curl -X POST https://api.resourcewatch.org/auth/user/find-by-ids <span class="se">\</span>
-H <span class="s2">"Authorization: Bearer &lt;your-token&gt;"</span> <span class="se">\</span>
-H <span class="s2">"Content-Type: application/json"</span>  -d <span class="se">\</span>
<span class="s1">'{
    "ids": [
        "0706f055b929453eb1547392123ae99e",
        "0c630aeb81464fcca9bebe5adcb731c8",
    ]
}'</span>
</code></pre>
<blockquote>
<p>Example response:</p>
</blockquote>
<pre class="highlight shell"><code>    <span class="o">{</span>
        <span class="s2">"data"</span>: <span class="o">[</span>
            <span class="o">{</span>
                <span class="s2">"provider"</span>: <span class="s2">"local"</span>,
                <span class="s2">"role"</span>: <span class="s2">"USER"</span>,
                <span class="s2">"_id"</span>: <span class="s2">"0706f055b929453eb1547392123ae99e"</span>,
                <span class="s2">"email"</span>: <span class="s2">"example@user.com"</span>,
                <span class="s2">"createdAt"</span>: <span class="s2">"2016-08-22T11:48:51.163Z"</span>,
                <span class="s2">"extraUserData"</span>: <span class="o">{</span>
                    <span class="s2">"apps"</span>: <span class="o">[</span>
                        <span class="s2">"rw"</span>,
                        <span class="s2">"gfw"</span>
                    <span class="o">]</span>
                <span class="o">}</span>,
                <span class="s2">"updatedAt"</span>: <span class="s2">"2019-12-18T15:59:57.333Z"</span>
            <span class="o">}</span>,
            <span class="o">{</span>
                <span class="s2">"provider"</span>: <span class="s2">"local"</span>,
                <span class="s2">"role"</span>: <span class="s2">"ADMIN"</span>,
                <span class="s2">"_id"</span>: <span class="s2">"0c630aeb81464fcca9bebe5adcb731c8"</span>,
                <span class="s2">"email"</span>: <span class="s2">"example2@user.com"</span>,
                <span class="s2">"createdAt"</span>: <span class="s2">"2016-08-22T11:48:51.163Z"</span>,
                <span class="s2">"extraUserData"</span>: <span class="o">{</span>
                    <span class="s2">"apps"</span>: <span class="o">[</span>
                        <span class="s2">"rw"</span>,
                        <span class="s2">"gfw"</span>,
                        <span class="s2">"prep"</span>,
                        <span class="s2">"aqueduct"</span>,
                        <span class="s2">"forest-atlas"</span>,
                        <span class="s2">"data4sdgs"</span>,
                        <span class="s2">"gfw-climate"</span>,
                        <span class="s2">"gfw-pro"</span>,
                        <span class="s2">"ghg-gdp"</span>
                    <span class="o">]</span>
                <span class="o">}</span>,
                <span class="s2">"updatedAt"</span>: <span class="s2">"2019-12-18T15:59:57.333Z"</span>
            <span class="o">}</span>
        <span class="o">]</span>
    <span class="o">}</span>
</code></pre>
          <h1 id="subscriptions">Subscriptions</h1>

<p>When communicating with the Subscriptions microservice from other microservices, you have access to special actions that are not available when using the public API. This section concerns subscriptions endpoints that offer special functionality when handling requests from other microservices.</p>

<h2 id="creating-a-subscription-for-another-user">Creating a subscription for another user</h2>

<blockquote>
<p>Creating a subscription for user with ID 123 - only works when called by other MS!</p>
</blockquote>
<pre class="highlight shell"><code>curl -X POST https://api.resourcewatch.org/v1/subscriptions <span class="se">\</span>
-H <span class="s2">"Authorization: Bearer &lt;your-token&gt;"</span> <span class="se">\</span>
-H <span class="s2">"Content-Type: application/json"</span>  -d <span class="se">\</span>
 <span class="s1">'{
    "name": "&lt;name&gt;",
    "datasets": ["&lt;dataset&gt;"],
    "params": { "geostore": "35a6d982388ee5c4e141c2bceac3fb72" },
    "datasetsQuery": [
        {
            "id": ":subscription_dataset_id",
            "type": "test_subscription",
            "threshold": 1
        }
    ],
    "application": "rw",
    "language": "en",
    "env": &lt;environment&gt;,
    "resource": { "type": "EMAIL", "content": "email@address.com" },
    "userId": "123"
}'</span>
</code></pre>
<p>You can create a subscription for another user by providing the user id in the body of the request.</p>

<p>This can only be done when performing requests from another microservice.</p>

<table><thead>
<tr>
<th>Field</th>
<th style="text-align: center">Description</th>
<th style="text-align: right">Type</th>
<th style="text-align: right">Required</th>
</tr>
</thead><tbody>
<tr>
<td>userId</td>
<td style="text-align: center">Id of the owner of the subscription - if not provided, it&rsquo;s set as the id of the user in the token.</td>
<td style="text-align: right">String</td>
<td style="text-align: right">No</td>
</tr>
</tbody></table>

<h2 id="updating-a-subscription-for-another-user">Updating a subscription for another user</h2>

<p>If the request comes from another microservice, then it is possible to modify subscriptions belonging to other users. Otherwise, you can only modify subscriptions if you are the owner of the subscription.</p>

<p>The following fields are available to be provided when modifying a subscription:</p>

<table><thead>
<tr>
<th>Field</th>
<th style="text-align: center">Description</th>
<th style="text-align: right">Type</th>
<th style="text-align: right">Required</th>
</tr>
</thead><tbody>
<tr>
<td>userId</td>
<td style="text-align: center"><a href="developer.html#updating-a-subscription-for-another-user">Check here for more info</a></td>
<td style="text-align: right">String</td>
<td style="text-align: right">No</td>
</tr>
</tbody></table>

<h2 id="finding-subscriptions-by-ids">Finding subscriptions by ids</h2>
<pre class="highlight shell"><code>curl -X POST https://api.resourcewatch.org/v1/subscriptions/find-by-ids <span class="se">\</span>
-H <span class="s2">"Authorization: Bearer &lt;your-token&gt;"</span>
-H <span class="s2">"Content-Type: application/json"</span>  -d <span class="se">\</span>
 <span class="s1">'{ "ids": ["5e4d273dce77c53768bc24f9"] }'</span>
</code></pre>
<blockquote>
<p>Example response:</p>
</blockquote>
<pre class="highlight json"><code><span class="w">
</span><span class="p">{</span><span class="w">
    </span><span class="s2">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="s2">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"subscription"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"5e4d273dce77c53768bc24f9"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"attributes"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="s2">"createdAt"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2020-02-19T12:17:01.176Z"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"userId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"5e2f0eaf9de40a6c87dd9b7d"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"resource"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                    </span><span class="s2">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"EMAIL"</span><span class="p">,</span><span class="w">
                    </span><span class="s2">"content"</span><span class="p">:</span><span class="w"> </span><span class="s2">"henrique.pacheco@vizzuality.com"</span><span class="w">
                </span><span class="p">},</span><span class="w">
                </span><span class="s2">"datasets"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                    </span><span class="s2">"20cc5eca-8c63-4c41-8e8e-134dcf1e6d76"</span><span class="w">
                </span><span class="p">],</span><span class="w">
                </span><span class="s2">"params"</span><span class="p">:</span><span class="w"> </span><span class="p">{},</span><span class="w">
                </span><span class="s2">"confirmed"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
                </span><span class="s2">"language"</span><span class="p">:</span><span class="w"> </span><span class="s2">"en"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"datasetsQuery"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                    </span><span class="p">{</span><span class="w">
                        </span><span class="s2">"threshold"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
                        </span><span class="s2">"lastSentDate"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2020-02-19T12:17:01.175Z"</span><span class="p">,</span><span class="w">
                        </span><span class="s2">"historical"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">
                        </span><span class="s2">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"20cc5eca-8c63-4c41-8e8e-134dcf1e6d76"</span><span class="p">,</span><span class="w">
                        </span><span class="s2">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"COUNT"</span><span class="w">
                    </span><span class="p">}</span><span class="w">
                </span><span class="p">],</span><span class="w">
                </span><span class="s2">"env"</span><span class="p">:</span><span class="w"> </span><span class="s2">"production"</span><span class="w">
            </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
<p>You can find a set of subscriptions given their ids using the following endpoint.</p>

<h2 id="finding-subscriptions-for-a-given-user">Finding subscriptions for a given user</h2>
<pre class="highlight shell"><code>curl -X POST https://api.resourcewatch.org/v1/subscriptions/user/5e2f0eaf9de40a6c87dd9b7d <span class="se">\</span>
-H <span class="s2">"Authorization: Bearer &lt;your-token&gt;"</span>
</code></pre>
<blockquote>
<p>Example response:</p>
</blockquote>
<pre class="highlight json"><code><span class="w">
</span><span class="p">{</span><span class="w">
    </span><span class="s2">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="s2">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"subscription"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"5e4d273dce77c53768bc24f9"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"attributes"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="s2">"createdAt"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2020-02-19T12:17:01.176Z"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"userId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"5e2f0eaf9de40a6c87dd9b7d"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"resource"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                    </span><span class="s2">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"EMAIL"</span><span class="p">,</span><span class="w">
                    </span><span class="s2">"content"</span><span class="p">:</span><span class="w"> </span><span class="s2">"henrique.pacheco@vizzuality.com"</span><span class="w">
                </span><span class="p">},</span><span class="w">
                </span><span class="s2">"datasets"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                    </span><span class="s2">"20cc5eca-8c63-4c41-8e8e-134dcf1e6d76"</span><span class="w">
                </span><span class="p">],</span><span class="w">
                </span><span class="s2">"params"</span><span class="p">:</span><span class="w"> </span><span class="p">{},</span><span class="w">
                </span><span class="s2">"confirmed"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
                </span><span class="s2">"language"</span><span class="p">:</span><span class="w"> </span><span class="s2">"en"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"datasetsQuery"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                    </span><span class="p">{</span><span class="w">
                        </span><span class="s2">"threshold"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
                        </span><span class="s2">"lastSentDate"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2020-02-19T12:17:01.175Z"</span><span class="p">,</span><span class="w">
                        </span><span class="s2">"historical"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">
                        </span><span class="s2">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"20cc5eca-8c63-4c41-8e8e-134dcf1e6d76"</span><span class="p">,</span><span class="w">
                        </span><span class="s2">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"COUNT"</span><span class="w">
                    </span><span class="p">}</span><span class="w">
                </span><span class="p">],</span><span class="w">
                </span><span class="s2">"env"</span><span class="p">:</span><span class="w"> </span><span class="s2">"production"</span><span class="w">
            </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
<p>You can find all the subscriptions associated with a given user id using the following endpoint.</p>

<p>This endpoint supports the following optional query parameters as filters:</p>

<table><thead>
<tr>
<th>Field</th>
<th style="text-align: center">Description</th>
<th style="text-align: right">Type</th>
</tr>
</thead><tbody>
<tr>
<td>application</td>
<td style="text-align: center">Application to which the subscription is associated.</td>
<td style="text-align: right">String</td>
</tr>
<tr>
<td>env</td>
<td style="text-align: center">Environment to which the subscription is associated.</td>
<td style="text-align: right">String</td>
</tr>
</tbody></table>

<h2 id="finding-all-subscriptions">Finding all subscriptions</h2>
<pre class="highlight shell"><code>curl -X GET https://api.resourcewatch.org/v1/subscriptions/find-all <span class="se">\</span>
-H <span class="s2">"Authorization: Bearer &lt;your-token&gt;"</span>
</code></pre>
<blockquote>
<p>Example response:</p>
</blockquote>
<pre class="highlight json"><code><span class="p">{</span><span class="w">
    </span><span class="s2">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="s2">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"subscription"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"57bc7f9bb67c5da7720babc3"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"attributes"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="s2">"name"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
                </span><span class="s2">"createdAt"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2019-10-09T06:17:54.098Z"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"userId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"57bc2631f077ce98007988f9"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"resource"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                    </span><span class="s2">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"EMAIL"</span><span class="p">,</span><span class="w">
                    </span><span class="s2">"content"</span><span class="p">:</span><span class="w"> </span><span class="s2">"your.email@resourcewatch.org"</span><span class="w">
                </span><span class="p">},</span><span class="w">
                </span><span class="s2">"datasets"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                    </span><span class="s2">"umd-loss-gain"</span><span class="w">
                </span><span class="p">],</span><span class="w">
                </span><span class="s2">"params"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                    </span><span class="s2">"geostore"</span><span class="p">:</span><span class="w"> </span><span class="s2">"d3015d189631c8e2acddda9a547260c4"</span><span class="w">
                </span><span class="p">},</span><span class="w">
                </span><span class="s2">"confirmed"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
                </span><span class="s2">"language"</span><span class="p">:</span><span class="w"> </span><span class="s2">"en"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"datasetsQuery"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">
                </span><span class="s2">"env"</span><span class="p">:</span><span class="w"> </span><span class="s2">"production"</span><span class="w">
            </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">],</span><span class="w">
    </span><span class="s2">"links"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"self"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://api.resourcewatch.org/v1/subscriptions/find-all?page[number]=1&amp;page[size]=10"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"first"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://api.resourcewatch.org/v1/subscriptions/find-all?page[number]=1&amp;page[size]=10"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"last"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://api.resourcewatch.org/v1/subscriptions/find-all?page[number]=1&amp;page[size]=10"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"prev"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://api.resourcewatch.org/v1/subscriptions/find-all?page[number]=1&amp;page[size]=10"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"next"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://api.resourcewatch.org/v1/subscriptions/find-all?page[number]=1&amp;page[size]=10"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="s2">"meta"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"total-pages"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
        </span><span class="s2">"total-items"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
        </span><span class="s2">"size"</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
<p>You can find all the subscriptions using the following endpoint.</p>

<p>This endpoint supports the following optional query parameters as filters:</p>

<table><thead>
<tr>
<th>Field</th>
<th style="text-align: center">Description</th>
<th style="text-align: right">Type</th>
<th style="text-align: right">Example</th>
</tr>
</thead><tbody>
<tr>
<td>application</td>
<td style="text-align: center">Application to which the subscription is associated.</td>
<td style="text-align: right">String</td>
<td style="text-align: right">&lsquo;rw&rsquo;</td>
</tr>
<tr>
<td>env</td>
<td style="text-align: center">Environment to which the subscription is associated.</td>
<td style="text-align: right">String</td>
<td style="text-align: right">&#39;production&rsquo;</td>
</tr>
<tr>
<td>updatedAtSince</td>
<td style="text-align: center">Filter returned subscriptions by the updatedAt date being before the date provided. Should be a valid ISO date string.</td>
<td style="text-align: right">String</td>
<td style="text-align: right">&#39;2020-03-25T09:16:22.068Z&rsquo;</td>
</tr>
<tr>
<td>updatedAtUntil</td>
<td style="text-align: center">Filter returned subscriptions by the updatedAt date being after the date provided. Should be a valid ISO date string.</td>
<td style="text-align: right">String</td>
<td style="text-align: right">&#39;2020-03-25T09:16:22.068Z&rsquo;</td>
</tr>
<tr>
<td>page[size]</td>
<td style="text-align: center">The number elements per page. The maximum allowed value is 100 and the default value is 10.</td>
<td style="text-align: right">Number</td>
<td style="text-align: right">10</td>
</tr>
<tr>
<td>page[number]</td>
<td style="text-align: center">The page to fetch. Defaults to 1.</td>
<td style="text-align: right">Number</td>
<td style="text-align: right">1</td>
</tr>
</tbody></table>

          <h1 id="microservice-reference">Microservice reference</h1>

<p>This document should give developers a bird&rsquo;s eye view of existing microservices, their status and resources, organized by namespace.</p>

<h2 id="core">Core</h2>

<table><thead>
<tr>
<th>Name</th>
<th style="text-align: center">URL</th>
<th style="text-align: right">Travis Status</th>
<th style="text-align: right">Code Coverage</th>
</tr>
</thead><tbody>
<tr>
<td>arcgis</td>
<td style="text-align: center"><a href="https://github.com/resource-watch/adapter-arcgis">Github</a></td>
<td style="text-align: right"><a href="https://travis-ci.org/resource-watch/adapter-arcgis"><img src="https://travis-ci.org/resource-watch/adapter-arcgis.svg?branch=develop" alt="Build Status" /></a></td>
<td style="text-align: right"><a href="https://codeclimate.com/github/resource-watch/adapter-arcgis/test_coverage"><img src="https://api.codeclimate.com/v1/badges/682efc4cf55c6a795782/test_coverage" alt="Test Coverage" /></a></td>
</tr>
<tr>
<td>bigquery</td>
<td style="text-align: center"><a href="https://github.com/resource-watch/adapter-bigquery">Github</a></td>
<td style="text-align: right"><a href="https://travis-ci.org/resource-watch/adapter-bigquery"><img src="https://travis-ci.org/resource-watch/adapter-bigquery.svg?branch=develop" alt="Build Status" /></a></td>
<td style="text-align: right"><a href="https://codeclimate.com/github/resource-watch/adapter-bigquery/test_coverage"><img src="https://api.codeclimate.com/v1/badges/383b48f860c6578ce531/test_coverage" alt="Test Coverage" /></a></td>
</tr>
<tr>
<td>carto</td>
<td style="text-align: center"><a href="https://github.com/resource-watch/rw-adapter-carto">Github</a></td>
<td style="text-align: right"><a href="https://travis-ci.org/resource-watch/rw-adapter-carto"><img src="https://travis-ci.org/resource-watch/rw-adapter-carto.svg?branch=develop" alt="Build Status" /></a></td>
<td style="text-align: right"><a href="https://codeclimate.com/github/resource-watch/rw-adapter-carto/test_coverage"><img src="https://api.codeclimate.com/v1/badges/0afec809bb5b7e1d37e7/test_coverage" alt="Test Coverage" /></a></td>
</tr>
<tr>
<td>control-tower</td>
<td style="text-align: center"><a href="https://github.com/resource-watch/control-tower">Github</a></td>
<td style="text-align: right"><a href="https://travis-ci.org/resource-watch/control-tower"><img src="https://travis-ci.org/resource-watch/control-tower.svg?branch=develop" alt="Build Status" /></a></td>
<td style="text-align: right"><a href="https://codeclimate.com/github/resource-watch/control-tower/test_coverage"><img src="https://api.codeclimate.com/v1/badges/6998e7a532fb2d138ca3/test_coverage" alt="Test Coverage" /></a></td>
</tr>
<tr>
<td>converter</td>
<td style="text-align: center"><a href="https://github.com/resource-watch/converter">Github</a></td>
<td style="text-align: right"><a href="https://travis-ci.org/resource-watch/converter"><img src="https://travis-ci.org/resource-watch/converter.svg?branch=develop" alt="Build Status" /></a></td>
<td style="text-align: right"><a href="https://codeclimate.com/github/resource-watch/converter/test_coverage"><img src="https://api.codeclimate.com/v1/badges/b67e263c0e624c8bb50f/test_coverage" alt="Test Coverage" /></a></td>
</tr>
<tr>
<td>dataset</td>
<td style="text-align: center"><a href="https://github.com/resource-watch/dataset/">Github</a></td>
<td style="text-align: right"><a href="https://travis-ci.org/resource-watch/dataset"><img src="https://travis-ci.org/resource-watch/dataset.svg?branch=develop" alt="Build Status" /></a></td>
<td style="text-align: right"><a href="https://codeclimate.com/github/resource-watch/dataset/test_coverage"><img src="https://api.codeclimate.com/v1/badges/6e90d8ae68d28c916a5c/test_coverage" alt="Test Coverage" /></a></td>
</tr>
<tr>
<td>doc-executor</td>
<td style="text-align: center"><a href="https://github.com/resource-watch/doc-executor">Github</a></td>
<td style="text-align: right"><a href="https://travis-ci.org/resource-watch/doc-executor"><img src="https://travis-ci.org/resource-watch/doc-executor.svg?branch=develop" alt="Build Status" /></a></td>
<td style="text-align: right"><a href="https://codeclimate.com/github/resource-watch/doc-executor/test_coverage"><img src="https://api.codeclimate.com/v1/badges/e738a794d9771d51f292/test_coverage" alt="Test Coverage" /></a></td>
</tr>
<tr>
<td>doc-orchestrator</td>
<td style="text-align: center"><a href="https://github.com/resource-watch/doc-orchestrator/">Github</a></td>
<td style="text-align: right"><a href="https://travis-ci.org/resource-watch/doc-orchestrator"><img src="https://travis-ci.org/resource-watch/doc-orchestrator.svg?branch=develop" alt="Build Status" /></a></td>
<td style="text-align: right"><a href="https://codeclimate.com/github/resource-watch/doc-orchestrator/test_coverage"><img src="https://api.codeclimate.com/v1/badges/9d531e64d694f0e77d86/test_coverage" alt="Test Coverage" /></a></td>
</tr>
<tr>
<td>doc-writer</td>
<td style="text-align: center"><a href="https://github.com/resource-watch/doc-writer/">Github</a></td>
<td style="text-align: right"><a href="https://travis-ci.org/resource-watch/doc-writer"><img src="https://travis-ci.org/resource-watch/doc-writer.svg?branch=develop" alt="Build Status" /></a></td>
<td style="text-align: right"><a href="https://codeclimate.com/github/resource-watch/doc-writer/test_coverage"><img src="https://api.codeclimate.com/v1/badges/51973ae3d8b03163522d/test_coverage" alt="Test Coverage" /></a></td>
</tr>
<tr>
<td>document</td>
<td style="text-align: center"><a href="https://github.com/resource-watch/document-adapter/">Github</a></td>
<td style="text-align: right"><a href="https://travis-ci.org/resource-watch/document-adapter"><img src="https://travis-ci.org/resource-watch/document-adapter.svg?branch=develop" alt="Build Status" /></a></td>
<td style="text-align: right"><a href="https://codeclimate.com/github/resource-watch/document-adapter/test_coverage"><img src="https://api.codeclimate.com/v1/badges/381fe72ebbdaaeb9aff4/test_coverage" alt="Test Coverage" /></a></td>
</tr>
<tr>
<td>gee</td>
<td style="text-align: center"><a href="https://github.com/resource-watch/adapter-earth-engine">Github</a></td>
<td style="text-align: right"><a href="https://travis-ci.org/resource-watch/adapter-earth-engine"><img src="https://travis-ci.org/resource-watch/adapter-earth-engine.svg?branch=dev" alt="Build Status" /></a></td>
<td style="text-align: right"><a href="https://codeclimate.com/github/resource-watch/adapter-earth-engine/test_coverage"><img src="https://api.codeclimate.com/v1/badges/b221d818e0e99f94d0c8/test_coverage" alt="Test Coverage" /></a></td>
</tr>
<tr>
<td>gee-tiles</td>
<td style="text-align: center"><a href="https://github.com/resource-watch/gee-tiles">Github</a></td>
<td style="text-align: right"><a href="https://travis-ci.org/resource-watch/gee-tiles"><img src="https://travis-ci.org/resource-watch/gee-tiles.svg?branch=dev" alt="Build Status" /></a></td>
<td style="text-align: right"><a href="https://codeclimate.com/github/resource-watch/gee-tiles/test_coverage"><img src="https://api.codeclimate.com/v1/badges/6c8dd3205ab1cb4a0073/test_coverage" alt="Test Coverage" /></a></td>
</tr>
<tr>
<td>geostore</td>
<td style="text-align: center"><a href="https://github.com/gfw-api/gfw-geostore-api">Github</a></td>
<td style="text-align: right"><a href="https://travis-ci.org/gfw-api/gfw-geostore-api"><img src="https://travis-ci.org/gfw-api/gfw-geostore-api.svg?branch=develop" alt="Build Status" /></a></td>
<td style="text-align: right"><a href="https://codeclimate.com/github/gfw-api/gfw-geostore-api/test_coverage"><img src="https://api.codeclimate.com/v1/badges/896da4f09a0ebb049753/test_coverage" alt="Test Coverage" /></a></td>
</tr>
<tr>
<td>graph-client</td>
<td style="text-align: center"><a href="https://github.com/resource-watch/graph-client/">Github</a></td>
<td style="text-align: right"><a href="https://travis-ci.org/resource-watch/graph-client"><img src="https://travis-ci.org/resource-watch/graph-client.svg?branch=develop" alt="Build Status" /></a></td>
<td style="text-align: right"><a href="https://codeclimate.com/github/resource-watch/graph-client/test_coverage"><img src="https://api.codeclimate.com/v1/badges/5fbe8f9c23d81587d091/test_coverage" alt="Test Coverage" /></a></td>
</tr>
<tr>
<td>layer</td>
<td style="text-align: center"><a href="https://github.com/resource-watch/layer">Github</a></td>
<td style="text-align: right"><a href="https://travis-ci.org/resource-watch/layer"><img src="https://travis-ci.org/resource-watch/layer.svg?branch=develop" alt="Build Status" /></a></td>
<td style="text-align: right"><a href="https://codeclimate.com/github/resource-watch/layer/test_coverage"><img src="https://api.codeclimate.com/v1/badges/31c04ea387e28ef9ada7/test_coverage" alt="Test Coverage" /></a></td>
</tr>
<tr>
<td>metadata</td>
<td style="text-align: center"><a href="https://github.com/resource-watch/rw_metadata">Github</a></td>
<td style="text-align: right"><a href="https://travis-ci.org/resource-watch/rw_metadata"><img src="https://travis-ci.org/resource-watch/rw_metadata.svg?branch=develop" alt="Build Status" /></a></td>
<td style="text-align: right"><a href="https://codeclimate.com/github/resource-watch/rw_metadata/test_coverage"><img src="https://api.codeclimate.com/v1/badges/93b1d3c022b33c438ce1/test_coverage" alt="Test Coverage" /></a></td>
</tr>
<tr>
<td>mail</td>
<td style="text-align: center"><a href="https://github.com/gfw-api/gfw-mail-api">Github</a></td>
<td style="text-align: right"><a href="https://travis-ci.org/gfw-api/gfw-mail-api"><img src="https://travis-ci.org/gfw-api/gfw-mail-api.svg?branch=develop" alt="Build Status" /></a></td>
<td style="text-align: right"><a href="https://codeclimate.com/github/gfw-api/gfw-mail-api/test_coverage"><img src="https://api.codeclimate.com/v1/badges/a4f13ba330b5d5573d7a/test_coverage" alt="Test Coverage" /></a></td>
</tr>
<tr>
<td>query</td>
<td style="text-align: center"><a href="https://github.com/resource-watch/query/">Github</a></td>
<td style="text-align: right"><a href="https://travis-ci.org/resource-watch/query"><img src="https://travis-ci.org/resource-watch/query.svg?branch=develop" alt="Build Status" /></a></td>
<td style="text-align: right"><a href="https://codeclimate.com/github/resource-watch/query/test_coverage"><img src="https://api.codeclimate.com/v1/badges/3e6b21174a2e8fe2192c/test_coverage" alt="Test Coverage" /></a></td>
</tr>
<tr>
<td>rw-lp</td>
<td style="text-align: center"><a href="https://github.com/resource-watch/rw-lp">Github</a></td>
<td style="text-align: right"></td>
<td style="text-align: right"></td>
</tr>
<tr>
<td>task-async</td>
<td style="text-align: center"><a href="https://github.com/resource-watch/task-executor">Github</a></td>
<td style="text-align: right"></td>
<td style="text-align: right"></td>
</tr>
<tr>
<td>vocabulary</td>
<td style="text-align: center"><a href="https://github.com/resource-watch/vocabulary-tag/">Github</a></td>
<td style="text-align: right"><a href="https://travis-ci.org/resource-watch/vocabulary-tag"><img src="https://travis-ci.org/resource-watch/vocabulary-tag.svg?branch=develop" alt="Build Status" /></a></td>
<td style="text-align: right"><a href="https://codeclimate.com/github/resource-watch/vocabulary-tag/test_coverage"><img src="https://api.codeclimate.com/v1/badges/89f70e66993b8524fd09/test_coverage" alt="Test Coverage" /></a></td>
</tr>
<tr>
<td>webshot</td>
<td style="text-align: center"><a href="https://github.com/resource-watch/webshot">Github</a></td>
<td style="text-align: right"><a href="https://travis-ci.org/resource-watch/webshot"><img src="https://travis-ci.org/resource-watch/webshot.svg?branch=develop" alt="Build Status" /></a></td>
<td style="text-align: right"><a href="https://codeclimate.com/github/resource-watch/webshot/test_coverage"><img src="https://api.codeclimate.com/v1/badges/e361eed538fcc656c7cd/test_coverage" alt="Test Coverage" /></a></td>
</tr>
<tr>
<td>widget</td>
<td style="text-align: center"><a href="https://github.com/resource-watch/widget">Github</a></td>
<td style="text-align: right"><a href="https://travis-ci.org/resource-watch/widget"><img src="https://travis-ci.org/resource-watch/widget.svg?branch=develop" alt="Build Status" /></a></td>
<td style="text-align: right"><a href="https://codeclimate.com/github/resource-watch/widget/test_coverage"><img src="https://api.codeclimate.com/v1/badges/a5b0be0d7e79db309b30/test_coverage" alt="Test Coverage" /></a></td>
</tr>
</tbody></table>

<h2 id="gfw">GFW</h2>

<table><thead>
<tr>
<th>Name</th>
<th style="text-align: center">URL</th>
<th style="text-align: right">Travis Status</th>
<th style="text-align: right">Code Coverage</th>
</tr>
</thead><tbody>
<tr>
<td>analysis-gee</td>
<td style="text-align: center"><a href="https://github.com/gfw-api/gfw-analysis-gee">Github</a></td>
<td style="text-align: right"><a href="https://travis-ci.org/gfw-api/gfw-analysis-gee"><img src="https://travis-ci.org/gfw-api/gfw-analysis-gee.svg?branch=dev" alt="Build Status" /></a></td>
<td style="text-align: right"><a href="https://codeclimate.com/github/gfw-api/gfw-analysis-gee/test_coverage"><img src="https://api.codeclimate.com/v1/badges/2d03ef51b43e72eae7e1/test_coverage" alt="Test Coverage" /></a></td>
</tr>
<tr>
<td>arcgis-proxy</td>
<td style="text-align: center"><a href="https://github.com/gfw-api/arcgis-proxy">Github</a></td>
<td style="text-align: right"><a href="https://travis-ci.org/gfw-api/arcgis-proxy"><img src="https://travis-ci.org/gfw-api/arcgis-proxy.svg?branch=develop" alt="Build Status" /></a></td>
<td style="text-align: right"><a href="https://codeclimate.com/github/gfw-api/arcgis-proxy/test_coverage"><img src="https://api.codeclimate.com/v1/badges/cccb3b1b648ce4686ca5/test_coverage" alt="Test Coverage" /></a></td>
</tr>
<tr>
<td>area</td>
<td style="text-align: center"><a href="https://github.com/gfw-api/gfw-area">Github</a></td>
<td style="text-align: right"><a href="https://travis-ci.org/gfw-api/gfw-area"><img src="https://travis-ci.org/gfw-api/gfw-area.svg?branch=develop" alt="Build Status" /></a></td>
<td style="text-align: right"><a href="https://codeclimate.com/github/gfw-api/gfw-area/test_coverage"><img src="https://api.codeclimate.com/v1/badges/d4eaa98d51c79d83159b/test_coverage" alt="Test Coverage" /></a></td>
</tr>
<tr>
<td>forest-change</td>
<td style="text-align: center"><a href="https://github.com/gfw-api/forest-change-analysis-elastic">Github</a></td>
<td style="text-align: right"><a href="https://travis-ci.org/gfw-api/forest-change-analysis-elastic"><img src="https://travis-ci.org/gfw-api/forest-change-analysis-elastic.svg?branch=develop" alt="Build Status" /></a></td>
<td style="text-align: right"><a href="https://codeclimate.com/github/gfw-api/forest-change-analysis-elastic/test_coverage"><img src="https://api.codeclimate.com/v1/badges/d86e27f2918b5cb53fdb/test_coverage" alt="Test Coverage" /></a></td>
</tr>
<tr>
<td>gfw-forma</td>
<td style="text-align: center"><a href="https://github.com/gfw-api/gfw-forma-alerts-api">Github</a></td>
<td style="text-align: right"><a href="https://travis-ci.org/gfw-api/gfw-forma-alerts-api"><img src="https://travis-ci.org/gfw-api/gfw-forma-alerts-api.svg?branch=develop" alt="Build Status" /></a></td>
<td style="text-align: right"><a href="https://codeclimate.com/github/gfw-api/gfw-forma-alerts-api/test_coverage"><img src="https://api.codeclimate.com/v1/badges/38c6573628d854533ee9/test_coverage" alt="Test Coverage" /></a></td>
</tr>
<tr>
<td>gfw-guira</td>
<td style="text-align: center"><a href="https://github.com/gfw-api/gfw-guira-loss-api">Github</a></td>
<td style="text-align: right"><a href="https://travis-ci.org/gfw-api/gfw-guira-loss-api"><img src="https://travis-ci.org/gfw-api/gfw-guira-loss-api.svg?branch=develop" alt="Build Status" /></a></td>
<td style="text-align: right"><a href="https://codeclimate.com/github/gfw-api/gfw-guira-loss-api/test_coverage"><img src="https://api.codeclimate.com/v1/badges/bd10718ad3aa55db6e7a/test_coverage" alt="Test Coverage" /></a></td>
</tr>
<tr>
<td>gfw-ogr</td>
<td style="text-align: center"><a href="https://github.com/gfw-api/gfw-ogr-api">Github</a></td>
<td style="text-align: right"><a href="https://travis-ci.org/gfw-api/gfw-ogr-api"><img src="https://travis-ci.org/gfw-api/gfw-ogr-api.svg?branch=develop" alt="Build Status" /></a></td>
<td style="text-align: right"><a href="https://codeclimate.com/github/gfw-api/gfw-ogr-api/test_coverage"><img src="https://api.codeclimate.com/v1/badges/a818cbdf6e1cb49d6256/test_coverage" alt="Test Coverage" /></a></td>
</tr>
<tr>
<td>gfw-prodes</td>
<td style="text-align: center"><a href="https://github.com/gfw-api/gfw-prodes-loss-api">Github</a></td>
<td style="text-align: right"><a href="https://travis-ci.org/gfw-api/gfw-prodes-loss-api"><img src="https://travis-ci.org/gfw-api/gfw-prodes-loss-api.svg?branch=develop" alt="Build Status" /></a></td>
<td style="text-align: right"><a href="https://codeclimate.com/github/gfw-api/gfw-prodes-loss-api/test_coverage"><img src="https://api.codeclimate.com/v1/badges/e683fe0cb0dc0b7cab57/test_coverage" alt="Test Coverage" /></a></td>
</tr>
<tr>
<td>gfw-umd</td>
<td style="text-align: center"><a href="https://github.com/gfw-api/gfw-umd-forest-api">Github</a></td>
<td style="text-align: right"><a href="https://travis-ci.org/gfw-api/gfw-umd-forest-api"><img src="https://travis-ci.org/gfw-api/gfw-umd-forest-api.svg?branch=develop" alt="Build Status" /></a></td>
<td style="text-align: right"><a href="https://codeclimate.com/github/gfw-api/gfw-umd-forest-api/test_coverage"><img src="https://api.codeclimate.com/v1/badges/3b10b3f9b97cb5e275ac/test_coverage" alt="Test Coverage" /></a></td>
</tr>
<tr>
<td>gfw-user</td>
<td style="text-align: center"><a href="https://github.com/gfw-api/gfw-user-api">Github</a></td>
<td style="text-align: right"><a href="https://travis-ci.org/gfw-api/gfw-user-api"><img src="https://travis-ci.org/gfw-api/gfw-user-api.svg?branch=develop" alt="Build Status" /></a></td>
<td style="text-align: right"><a href="https://codeclimate.com/github/gfw-api/gfw-user-api/test_coverage"><img src="https://api.codeclimate.com/v1/badges/9f3238f6631f9c5e4ad7/test_coverage" alt="Test Coverage" /></a></td>
</tr>
<tr>
<td>gs-pro-config</td>
<td style="text-align: center"><a href="https://github.com/gfw-api/gs-pro-config/">Github</a></td>
<td style="text-align: right"><a href="https://travis-ci.org/gfw-api/gs-pro-config"><img src="https://travis-ci.org/gfw-api/gs-pro-config.svg?branch=develop" alt="Build Status" /></a></td>
<td style="text-align: right"><a href="https://codeclimate.com/github/gfw-api/gs-pro-config/test_coverage"><img src="https://api.codeclimate.com/v1/badges/4a6bd3e90a49a0a6000c/test_coverage" alt="Test Coverage" /></a></td>
</tr>
<tr>
<td>glad-analysis-athena</td>
<td style="text-align: center"><a href="https://github.com/gfw-api/glad-analysis-tiled">Github</a></td>
<td style="text-align: right"><a href="https://travis-ci.org/gfw-api/glad-analysis-tiled"><img src="https://travis-ci.org/gfw-api/glad-analysis-tiled.svg?branch=develop" alt="Build Status" /></a></td>
<td style="text-align: right"><a href="https://codeclimate.com/github/gfw-api/glad-analysis-tiled/test_coverage"><img src="https://api.codeclimate.com/v1/badges/55617d7d21d384ce68e6/test_coverage" alt="Test Coverage" /></a></td>
</tr>
<tr>
<td>high-res</td>
<td style="text-align: center"><a href="https://github.com/gfw-api/high-res">Github</a></td>
<td style="text-align: right"><a href="https://travis-ci.org/gfw-api/high-res"><img src="https://travis-ci.org/gfw-api/high-res.svg?branch=develop" alt="Build Status" /></a></td>
<td style="text-align: right"><a href="https://codeclimate.com/github/gfw-api/high-res/test_coverage"><img src="https://api.codeclimate.com/v1/badges/8a00bada07dadb6aa23a/test_coverage" alt="Test Coverage" /></a></td>
</tr>
<tr>
<td>imazon</td>
<td style="text-align: center"><a href="https://github.com/gfw-api/gfw-imazon-alerts-api">Github</a></td>
<td style="text-align: right"><a href="https://travis-ci.org/gfw-api/gfw-imazon-alerts-api"><img src="https://travis-ci.org/gfw-api/gfw-imazon-alerts-api.svg?branch=develop" alt="Build Status" /></a></td>
<td style="text-align: right"><a href="https://codeclimate.com/github/gfw-api/gfw-imazon-alerts-api/test_coverage"><img src="https://api.codeclimate.com/v1/badges/7c1d35d3f2ddb21fa6a4/test_coverage" alt="Test Coverage" /></a></td>
</tr>
<tr>
<td>quicc</td>
<td style="text-align: center"><a href="https://github.com/gfw-api/gfw-quicc-alerts-api">Github</a></td>
<td style="text-align: right"><a href="https://travis-ci.org/gfw-api/gfw-quicc-alerts-api"><img src="https://travis-ci.org/gfw-api/gfw-quicc-alerts-api.svg?branch=develop" alt="Build Status" /></a></td>
<td style="text-align: right"><a href="https://codeclimate.com/github/gfw-api/gfw-quicc-alerts-api/test_coverage"><img src="https://api.codeclimate.com/v1/badges/ec043e87f221b1d8a547/test_coverage" alt="Test Coverage" /></a></td>
</tr>
<tr>
<td>story</td>
<td style="text-align: center"><a href="https://github.com/gfw-api/gfw-story-api">Github</a></td>
<td style="text-align: right"><a href="https://travis-ci.org/gfw-api/gfw-story-api"><img src="https://travis-ci.org/gfw-api/gfw-story-api.svg?branch=develop" alt="Build Status" /></a></td>
<td style="text-align: right"><a href="https://codeclimate.com/github/gfw-api/gfw-story-api/test_coverage"><img src="https://api.codeclimate.com/v1/badges/719013c600d29a695000/test_coverage" alt="Test Coverage" /></a></td>
</tr>
<tr>
<td>subscriptions</td>
<td style="text-align: center"><a href="https://github.com/gfw-api/gfw-subscription-api">Github</a></td>
<td style="text-align: right"><a href="https://travis-ci.org/gfw-api/gfw-subscription-api"><img src="https://travis-ci.org/gfw-api/gfw-subscription-api.svg?branch=develop" alt="Build Status" /></a></td>
<td style="text-align: right"><a href="https://codeclimate.com/github/gfw-api/gfw-subscription-api/test_coverage"><img src="https://api.codeclimate.com/v1/badges/fd35453ead111fbb221c/test_coverage" alt="Test Coverage" /></a></td>
</tr>
<tr>
<td>true-color-tiles</td>
<td style="text-align: center"><a href="https://github.com/gfw-api/true-color-tiles">Github</a></td>
<td style="text-align: right"><a href="https://travis-ci.org/gfw-api/true-color-tiles"><img src="https://travis-ci.org/gfw-api/true-color-tiles.svg?branch=develop" alt="Build Status" /></a></td>
<td style="text-align: right"><a href="https://codeclimate.com/github/gfw-api/true-color-tiles/test_coverage"><img src="https://api.codeclimate.com/v1/badges/90a8a96a1b064267f42d/test_coverage" alt="Test Coverage" /></a></td>
</tr>
<tr>
<td>viirs-fires</td>
<td style="text-align: center"><a href="https://github.com/gfw-api/gfw-viirs-fires-api">Github</a></td>
<td style="text-align: right"><a href="https://travis-ci.org/gfw-api/gfw-viirs-fires-api"><img src="https://travis-ci.org/gfw-api/gfw-viirs-fires-api.svg?branch=develop" alt="Build Status" /></a></td>
<td style="text-align: right"><a href="https://codeclimate.com/github/gfw-api/gfw-viirs-fires-api/test_coverage"><img src="https://api.codeclimate.com/v1/badges/5978e5b572f6194cbe42/test_coverage" alt="Test Coverage" /></a></td>
</tr>
</tbody></table>

<h2 id="fw">FW</h2>

<table><thead>
<tr>
<th>Name</th>
<th style="text-align: center">URL</th>
<th style="text-align: right">Travis Status</th>
<th style="text-align: right">Code Coverage</th>
</tr>
</thead><tbody>
<tr>
<td>forest-watcher-api</td>
<td style="text-align: center"><a href="https://github.com/gfw-api/forest-watcher">Github</a></td>
<td style="text-align: right"><a href="https://travis-ci.org/gfw-api/forest-watcher"><img src="https://travis-ci.org/gfw-api/forest-watcher.svg?branch=develop" alt="Build Status" /></a></td>
<td style="text-align: right"><a href="https://codeclimate.com/github/gfw-api/forest-watcher/test_coverage"><img src="https://api.codeclimate.com/v1/badges/dfce5cd3c6aa92bf95ea/test_coverage" alt="Test Coverage" /></a></td>
</tr>
<tr>
<td>forms</td>
<td style="text-align: center"><a href="https://github.com/gfw-api/gfw-forms-api">Github</a></td>
<td style="text-align: right"><a href="https://travis-ci.org/gfw-api/gfw-forms-api"><img src="https://travis-ci.org/gfw-api/gfw-forms-api.svg?branch=develop" alt="Build Status" /></a></td>
<td style="text-align: right"><a href="https://codeclimate.com/github/gfw-api/gfw-forms-api/test_coverage"><img src="https://api.codeclimate.com/v1/badges/fead108699d985f0b266/test_coverage" alt="Test Coverage" /></a></td>
</tr>
<tr>
<td>fw-alerts</td>
<td style="text-align: center"><a href="https://github.com/gfw-api/fw-alerts">Github</a></td>
<td style="text-align: right"><a href="https://travis-ci.org/gfw-api/fw-alerts"><img src="https://travis-ci.org/gfw-api/fw-alerts.svg?branch=develop" alt="Build Status" /></a></td>
<td style="text-align: right"><a href="https://codeclimate.com/github/gfw-api/fw-alerts/test_coverage"><img src="https://api.codeclimate.com/v1/badges/40d4b1e823a36f2041a4/test_coverage" alt="Test Coverage" /></a></td>
</tr>
<tr>
<td>fw-contextual-layers</td>
<td style="text-align: center"><a href="https://github.com/gfw-api/fw-contextual-layers">Github</a></td>
<td style="text-align: right"><a href="https://travis-ci.org/gfw-api/fw-contextual-layers"><img src="https://travis-ci.org/gfw-api/fw-contextual-layers.svg?branch=develop" alt="Build Status" /></a></td>
<td style="text-align: right"><a href="https://codeclimate.com/github/gfw-api/fw-contextual-layers/test_coverage"><img src="https://api.codeclimate.com/v1/badges/c1954d5df380ff14aae1/test_coverage" alt="Test Coverage" /></a></td>
</tr>
<tr>
<td>fw-teams</td>
<td style="text-align: center"><a href="https://github.com/gfw-api/fw-teams">Github</a></td>
<td style="text-align: right"><a href="https://travis-ci.org/gfw-api/fw-teams"><img src="https://travis-ci.org/gfw-api/fw-teams.svg?branch=develop" alt="Build Status" /></a></td>
<td style="text-align: right"><a href="https://codeclimate.com/github/gfw-api/fw-teams/test_coverage"><img src="https://api.codeclimate.com/v1/badges/67ef5c9f03336a7e5608/test_coverage" alt="Test Coverage" /></a></td>
</tr>
</tbody></table>

<h2 id="aqueduct">Aqueduct</h2>

<table><thead>
<tr>
<th>Name</th>
<th style="text-align: center">URL</th>
<th style="text-align: right">Travis Status</th>
<th style="text-align: right">Code Coverage</th>
</tr>
</thead><tbody>
<tr>
<td>aqueduct-analysis</td>
<td style="text-align: center"><a href="https://github.com/resource-watch/aqueduct-analysis-microservice">Github</a></td>
<td style="text-align: right"><a href="https://travis-ci.org/resource-watch/aqueduct-analysis-microservice"><img src="https://travis-ci.org/resource-watch/aqueduct-analysis-microservice.svg?branch=develop" alt="Build Status" /></a></td>
<td style="text-align: right"><a href="https://codeclimate.com/github/resource-watch/aqueduct-analysis-microservice/test_coverage"><img src="https://api.codeclimate.com/v1/badges/412dbad07a559dbd4105/test_coverage" alt="Test Coverage" /></a></td>
</tr>
</tbody></table>

<h2 id="prep">PREP</h2>

<table><thead>
<tr>
<th>Name</th>
<th style="text-align: center">URL</th>
<th style="text-align: right">Travis Status</th>
<th style="text-align: right">Code Coverage</th>
</tr>
</thead><tbody>
<tr>
<td>nexgddp</td>
<td style="text-align: center"><a href="https://github.com/Vizzuality/prep-nexgddp">Github</a></td>
<td style="text-align: right"><a href="https://travis-ci.org/Vizzuality/prep-nexgddp"><img src="https://travis-ci.org/Vizzuality/prep-nexgddp.svg?branch=develop" alt="Build Status" /></a></td>
<td style="text-align: right"><a href="https://codeclimate.com/github/Vizzuality/prep-nexgddp/test_coverage"><img src="https://api.codeclimate.com/v1/badges/95cbefa669563539f187/test_coverage" alt="Test Coverage" /></a></td>
</tr>
<tr>
<td>prep-api</td>
<td style="text-align: center"><a href="https://github.com/resource-watch/prep-api">Github</a></td>
<td style="text-align: right"><a href="https://travis-ci.org/resource-watch/prep-api"><img src="https://travis-ci.org/resource-watch/prep-api.svg?branch=master" alt="Build Status" /></a></td>
<td style="text-align: right"><a href="https://codeclimate.com/github/resource-watch/prep-api/test_coverage"><img src="https://api.codeclimate.com/v1/badges/59331ed7504c0e00db4c/test_coverage" alt="Test Coverage" /></a></td>
</tr>
<tr>
<td>prep-app</td>
<td style="text-align: center"><a href="https://github.com/resource-watch/prep-app">Github</a></td>
<td style="text-align: right"></td>
<td style="text-align: right"></td>
</tr>
<tr>
<td>prep-manager</td>
<td style="text-align: center"><a href="https://github.com/resource-watch/prep-manager">Github</a></td>
<td style="text-align: right"></td>
<td style="text-align: right"></td>
</tr>
<tr>
<td>proxy</td>
<td style="text-align: center"><a href="https://github.com/resource-watch/proxy">Github</a></td>
<td style="text-align: right"><a href="https://travis-ci.org/resource-watch/proxy"><img src="https://travis-ci.org/resource-watch/proxy.svg?branch=develop" alt="Build Status" /></a></td>
<td style="text-align: right"><a href="https://codeclimate.com/github/resource-watch/proxy/test_coverage"><img src="https://api.codeclimate.com/v1/badges/2d6843b256ec3549b0b5/test_coverage" alt="Test Coverage" /></a></td>
</tr>
</tbody></table>

<h2 id="climate-watch">Climate Watch</h2>

<table><thead>
<tr>
<th>Name</th>
<th style="text-align: center">URL</th>
<th style="text-align: right">Travis Status</th>
<th style="text-align: right">Code Coverage</th>
</tr>
</thead><tbody>
<tr>
<td>Climate Watch Flagship</td>
<td style="text-align: center"><a href="https://github.com/Vizzuality/climate-watch">Github</a></td>
<td style="text-align: right"></td>
<td style="text-align: right"></td>
</tr>
<tr>
<td>Climate Watch India Platform</td>
<td style="text-align: center"><a href="https://github.com/ClimateWatch-Vizzuality/india-platform">Github</a></td>
<td style="text-align: right"></td>
<td style="text-align: right"></td>
</tr>
<tr>
<td>Climate Watch Indonesia Platform</td>
<td style="text-align: center"><a href="https://github.com/ClimateWatch-Vizzuality/indonesia-platform">Github</a></td>
<td style="text-align: right"></td>
<td style="text-align: right"></td>
</tr>
<tr>
<td>Climate Watch South Africa Platform</td>
<td style="text-align: center"><a href="https://github.com/ClimateWatch-Vizzuality/south-africa-platform">Github</a></td>
<td style="text-align: right"></td>
<td style="text-align: right"></td>
</tr>
<tr>
<td>Climate Watch: Emissions Scenario Portal</td>
<td style="text-align: center"><a href="https://github.com/Vizzuality/emissions-scenario-portal">Github</a></td>
<td style="text-align: right"></td>
<td style="text-align: right"></td>
</tr>
</tbody></table>

<h2 id="rw">RW</h2>

<table><thead>
<tr>
<th>Name</th>
<th style="text-align: center">URL</th>
<th style="text-align: right">Travis Status</th>
<th style="text-align: right">Code Coverage</th>
</tr>
</thead><tbody>
<tr>
<td>resource-watch-manager</td>
<td style="text-align: center"><a href="https://github.com/resource-watch/resource-watch-manager/">Github</a></td>
<td style="text-align: right"><a href="https://travis-ci.org/resource-watch/resource-watch-manager"><img src="https://travis-ci.org/resource-watch/resource-watch-manager.svg?branch=develop" alt="Build Status" /></a></td>
<td style="text-align: right"><a href="https://codeclimate.com/github/resource-watch/resource-watch-manager/test_coverage"><img src="https://api.codeclimate.com/v1/badges/cc3b209e57a896fe6d7c/test_coverage" alt="Test Coverage" /></a></td>
</tr>
</tbody></table>

          <h1 id="api-smoke-tests">API Smoke Tests</h1>

<p>This chapter covers the existing API Smoke Tests, including instructions on how to manage existing tests and create new ones.</p>

<p>The API Smoke Tests are implemented using Canaries provided by AWS Synthetics <a href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/CloudWatch_Synthetics_Canaries.html">(docs here)</a>.</p>

<h2 id="template-for-smoke-tests">Template for smoke tests</h2>

<blockquote>
<p>Template for an AWS Synthetics Canary</p>
</blockquote>
<pre class="highlight javascript"><code><span class="kr">const</span> <span class="nx">synthetics</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'Synthetics'</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">log</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'SyntheticsLogger'</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">AWS</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'aws-sdk'</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">https</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'https'</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">http</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'http'</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">apiCanaryBlueprint</span> <span class="o">=</span> <span class="nx">async</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>

  <span class="kr">const</span> <span class="nx">verifyRequest</span> <span class="o">=</span> <span class="nx">async</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">requestOption</span><span class="p">,</span> <span class="nx">body</span> <span class="o">=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="c1">// Prep request</span>
      <span class="nx">log</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s2">"Making request with options: "</span> <span class="o">+</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">requestOption</span><span class="p">));</span>
      <span class="kd">let</span> <span class="nx">req</span> <span class="o">=</span> <span class="p">(</span><span class="nx">requestOption</span><span class="p">.</span><span class="nx">port</span> <span class="o">===</span> <span class="mi">443</span><span class="p">)</span> <span class="p">?</span> <span class="nx">https</span><span class="p">.</span><span class="nx">request</span><span class="p">(</span><span class="nx">requestOption</span><span class="p">)</span> <span class="p">:</span> <span class="nx">http</span><span class="p">.</span><span class="nx">request</span><span class="p">(</span><span class="nx">requestOption</span><span class="p">);</span>

      <span class="c1">// POST body data</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">body</span><span class="p">)</span> <span class="p">{</span> <span class="nx">req</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">body</span><span class="p">));</span> <span class="p">}</span>

      <span class="c1">// Handle response</span>
      <span class="nx">req</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'response'</span><span class="p">,</span> <span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">log</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s2">`Status Code: </span><span class="p">${</span><span class="nx">res</span><span class="p">.</span><span class="nx">statusCode</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>

        <span class="c1">// Assert the status code returned</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">statusCode</span> <span class="o">!==</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">reject</span><span class="p">(</span><span class="s2">"Failed: "</span> <span class="o">+</span> <span class="nx">requestOption</span><span class="p">.</span><span class="nx">path</span> <span class="o">+</span> <span class="s2">" with status code "</span> <span class="o">+</span> <span class="nx">res</span><span class="p">.</span><span class="nx">statusCode</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="c1">// Grab body chunks and piece returned body together</span>
        <span class="kd">let</span> <span class="nx">body</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'data'</span><span class="p">,</span> <span class="p">(</span><span class="nx">chunk</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="nx">body</span> <span class="o">+=</span> <span class="nx">chunk</span><span class="p">.</span><span class="nx">toString</span><span class="p">();</span> <span class="p">});</span>

        <span class="c1">// Resolve providing the returned body</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'end'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nx">resolve</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">body</span><span class="p">)));</span>
      <span class="p">});</span>

      <span class="c1">// Reject on error</span>
      <span class="nx">req</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'error'</span><span class="p">,</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">reject</span><span class="p">(</span><span class="nx">error</span><span class="p">));</span>
      <span class="nx">req</span><span class="p">.</span><span class="nx">end</span><span class="p">();</span>
    <span class="p">});</span>
  <span class="p">}</span>

  <span class="c1">// Build request options</span>
  <span class="kd">let</span> <span class="nx">requestOptions</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">hostname</span><span class="p">:</span> <span class="s2">"api.resourcewatch.org"</span><span class="p">,</span>
    <span class="na">method</span><span class="p">:</span> <span class="s2">"GET"</span><span class="p">,</span>
    <span class="na">path</span><span class="p">:</span> <span class="s2">"/v1/dataset"</span><span class="p">,</span>
    <span class="na">port</span><span class="p">:</span> <span class="mi">443</span><span class="p">,</span>
    <span class="na">headers</span><span class="p">:</span> <span class="p">{</span>
      <span class="s1">'User-Agent'</span><span class="p">:</span> <span class="nx">synthetics</span><span class="p">.</span><span class="nx">getCanaryUserAgentString</span><span class="p">(),</span>
      <span class="s1">'Content-Type'</span><span class="p">:</span> <span class="s1">'application/json'</span><span class="p">,</span>
    <span class="p">},</span>
  <span class="p">};</span>

  <span class="c1">// Find and use secret for auth token</span>
  <span class="kr">const</span> <span class="nx">secretsManager</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">AWS</span><span class="p">.</span><span class="nx">SecretsManager</span><span class="p">();</span>
  <span class="nx">await</span> <span class="nx">secretsManager</span><span class="p">.</span><span class="nx">getSecretValue</span><span class="p">({</span> <span class="na">SecretId</span><span class="p">:</span> <span class="s2">"gfw-api/token"</span> <span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="nx">log</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nx">stack</span><span class="p">);</span>
    <span class="nx">log</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
    <span class="nx">requestOptions</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span><span class="s1">'Authorization'</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"Bearer "</span> <span class="o">+</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">data</span><span class="p">[</span><span class="s2">"SecretString"</span><span class="p">])[</span><span class="s2">"token"</span><span class="p">];</span>
  <span class="p">}).</span><span class="nx">promise</span><span class="p">();</span>

  <span class="c1">// Find and use secret for hostname</span>
  <span class="nx">await</span> <span class="nx">secretsManager</span><span class="p">.</span><span class="nx">getSecretValue</span><span class="p">({</span> <span class="na">SecretId</span><span class="p">:</span> <span class="s2">"wri-api/smoke-tests-host"</span> <span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="nx">log</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nx">stack</span><span class="p">);</span>
    <span class="nx">log</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
    <span class="nx">requestOptions</span><span class="p">.</span><span class="nx">hostname</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">data</span><span class="p">[</span><span class="s2">"SecretString"</span><span class="p">])[</span><span class="s2">"smoke-tests-host"</span><span class="p">];</span>
  <span class="p">}).</span><span class="nx">promise</span><span class="p">();</span>

  <span class="kr">const</span> <span class="nx">body</span> <span class="o">=</span> <span class="nx">await</span> <span class="nx">verifyRequest</span><span class="p">(</span><span class="nx">requestOptions</span><span class="p">);</span>
  <span class="kr">const</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">body</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">id</span><span class="p">;</span>

  <span class="c1">// Change needed request options</span>
  <span class="nx">requestOptions</span><span class="p">.</span><span class="nx">method</span> <span class="o">=</span> <span class="s2">"GET"</span><span class="p">;</span>
  <span class="nx">requestOptions</span><span class="p">.</span><span class="nx">path</span> <span class="o">=</span> <span class="s2">"/v1/dataset/"</span><span class="o">+</span><span class="nx">id</span><span class="p">;</span>

  <span class="c1">// Make second request</span>
  <span class="nx">await</span> <span class="nx">verifyRequest</span><span class="p">(</span><span class="nx">requestOptions</span><span class="p">);</span>
<span class="p">};</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">handler</span> <span class="o">=</span> <span class="nx">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">await</span> <span class="nx">apiCanaryBlueprint</span><span class="p">();</span>
<span class="p">};</span>
</code></pre>
<p>New tests should be based on the template displayed on the side, in order to take advantage of the configurations already in place.</p>

<p>Tests can execute multiple requests, but please minimize the number of interactions with databases to avoid creating junk data (for this reason, smoke testing POST, PATCH and DELETE endpoints is not recommended).</p>

<p>Another thing to notice is the usage of AWS secrets for storing a token to execute the request (<code class="prettyprint">gfw-api/token</code>), as well as the hostname where the test will be executed (<code class="prettyprint">wri-api/smoke-tests-host</code>).</p>

<p>The template on the side executes a GET request to <code class="prettyprint">/v1/dataset</code>, grabs the first ID in the response data and executes a second GET request to the <code class="prettyprint">/v1/dataset/:id</code> endpoint.</p>

<p><em>The test will pass if there are no exceptions thrown or promise rejections during the execution of the test. For the example on the side, the test will fail if any of the requests performed returns a status code that is not 200.</em></p>

<h2 id="things-to-pay-attention">Things to pay attention</h2>

<h3 id="use-a-user-to-run-the-tests">Use a user to run the tests</h3>

<p>Please ensure that all tests are ran using a token for a user <strong>which was specifically created for running the tests</strong>. Also, it goes without saying, please don&rsquo;t share either the token or the credentials for the user running the tests with anyone.</p>

<h3 id="always-configure-alarms-for-the-smoke-tests">Always configure alarms for the smoke tests</h3>

<p>Smoke tests by default are created without an associated alarm. When managing or creating smoke tests, <strong>please ensure that each test has a unique alarm associated to it</strong>.</p>

<p>Also, <strong>please ensure that the created alarm has an action defined to notify someone in case of failure of a test</strong>.</p>

<h2 id="running-smoke-tests-locally">Running smoke tests locally</h2>

<blockquote>
<p>Step 5 (before):</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">exports</span><span class="p">.</span><span class="nx">handler</span> <span class="o">=</span> <span class="nx">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">await</span> <span class="nx">apiCanaryBlueprint</span><span class="p">();</span>
<span class="p">};</span>
</code></pre>
<blockquote>
<p>Step 5 (after):</p>
</blockquote>
<pre class="highlight javascript"><code><span class="nx">apiCanaryBlueprint</span><span class="p">();</span>
</code></pre>
<p>In order to run smoke tests on your local machine for testing the script, some modifications need to be done:</p>

<ol>
<li>Copy the smoke test script into a file in your local machine (in this case, we&rsquo;re going to assume the name the file as <code class="prettyprint">index.js</code>).</li>
<li>Comment out any references to the <code class="prettyprint">Synthetics</code> NPM package, which is only available for internal usage in the canary script.</li>
<li>Replace all <code class="prettyprint">log.info</code> references (or any other method of the <code class="prettyprint">log</code> package) with <code class="prettyprint">console.log</code> and comment out the usage of the <code class="prettyprint">SyntheticsLogger</code> NPM package.</li>
<li>Comment out references to the usage of AWS secrets and to the <code class="prettyprint">aws-sdk</code> NPM package.</li>
<li>Replace the last lines of the script (see on the side).</li>
</ol>

<p>After these changes, you should be able to run the script locally using <code class="prettyprint">node index.js</code>. Remember that any exception or error thrown will cause the test to fail, otherwise the test will be considered a pass. If you want to explicitly fail the test if some assertion is not valid, you can throw a new Error with a message for debugging.</p>

<p>Before updating the script once again in AWS Synthetics, <strong>don&rsquo;t forget to revert ALL the changes (just follow the steps in the reverse order)</strong>.</p>

          <h1 id="query-transformations">Query transformations</h1>

<p><strong>While the WRI API aims to make the query interface as broad and transparent as possible, some of the querying options described below will not be available for specific dataset providers, depending on this API&rsquo;s implementation or limitations on the actual data provider&rsquo;s side.</strong></p>

<p>Additionally to provider-specific limitations, every SQL query is transformed by <a href="https://github.com/resource-watch/sql2json">the <code class="prettyprint">sql2json</code> microservice</a>, also maintained as <a href="https://www.npmjs.com/package/sql2json">NPM package</a>. There is a first conversion from SQL to JSON, and then from JSON to a SQL syntax that is compatible with <a href="https://github.com/NLPchina/elasticsearch-sql">the Elasticsearch SQL plugin</a>.</p>

<p>You can read more about the limitations of using SQL with Elasticsearch <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/sql-limitations.html">here</a>.</p>

          <h1 id="microservices">Microservices</h1>

<p>A list of information related to the microservices</p>

<aside class="notice">
    These services are only available to ADMIN users.
</aside>

<h2 id="list-all-registered-microservices">List all registered microservices</h2>

<p>To obtain a list of all the registered microservices:</p>
<pre class="highlight shell"><code>curl -X GET https://api.resourcewatch.org/api/v1/microservice <span class="se">\</span>
-H <span class="s2">"Authorization: Bearer &lt;your-token&gt;"</span>
</code></pre>
<blockquote>
<p>Example response:</p>
</blockquote>
<pre class="highlight json"><code><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
        </span><span class="s2">"infoStatus"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="s2">"numRetries"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
            </span><span class="s2">"error"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
            </span><span class="s2">"lastCheck"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2019-02-04T14:05:30.748Z"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="s2">"pathInfo"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/info"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"pathLive"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/ping"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"status"</span><span class="p">:</span><span class="w"> </span><span class="s2">"active"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"cache"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">
        </span><span class="s2">"uncache"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">
        </span><span class="s2">"tags"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
            </span><span class="s2">"dataset"</span><span class="w">

        </span><span class="p">],</span><span class="w">
        </span><span class="s2">"_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"id"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Dataset"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"url"</span><span class="p">:</span><span class="w"> </span><span class="s2">"http://dataset.default.svc.cluster.local:3000"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"version"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
        </span><span class="s2">"endpoints"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
            </span><span class="p">{</span><span class="w">
                </span><span class="s2">"redirect"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                    </span><span class="s2">"method"</span><span class="p">:</span><span class="w"> </span><span class="s2">"GET"</span><span class="p">,</span><span class="w">
                    </span><span class="s2">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/api/v1/dataset"</span><span class="w">
                </span><span class="p">},</span><span class="w">
                </span><span class="s2">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/v1/dataset"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"method"</span><span class="p">:</span><span class="w"> </span><span class="s2">"GET"</span><span class="w">
            </span><span class="p">},</span><span class="w">
            </span><span class="p">{</span><span class="w">
                </span><span class="s2">"redirect"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                    </span><span class="s2">"method"</span><span class="p">:</span><span class="w"> </span><span class="s2">"POST"</span><span class="p">,</span><span class="w">
                    </span><span class="s2">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/api/v1/dataset/find-by-ids"</span><span class="w">
                </span><span class="p">},</span><span class="w">
                </span><span class="s2">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/v1/dataset/find-by-ids"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"method"</span><span class="p">:</span><span class="w"> </span><span class="s2">"POST"</span><span class="w">
            </span><span class="p">}</span><span class="w">
        </span><span class="p">],</span><span class="w">
        </span><span class="s2">"updatedAt"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2019-01-24T13:04:46.728Z"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"swagger"</span><span class="p">:</span><span class="w"> </span><span class="s2">"{}"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
        </span><span class="s2">"infoStatus"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="s2">"numRetries"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
            </span><span class="s2">"error"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
            </span><span class="s2">"lastCheck"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2019-02-04T14:05:30.778Z"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="s2">"pathInfo"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/info"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"pathLive"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/ping"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"status"</span><span class="p">:</span><span class="w"> </span><span class="s2">"active"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"cache"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
            </span><span class="s2">"layer"</span><span class="w">
        </span><span class="p">],</span><span class="w">
        </span><span class="s2">"uncache"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
            </span><span class="s2">"layer"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"dataset"</span><span class="w">
        </span><span class="p">],</span><span class="w">
        </span><span class="s2">"tags"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
            </span><span class="s2">"layer"</span><span class="w">
        </span><span class="p">],</span><span class="w">
        </span><span class="s2">"_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"5aa667d1aee7ae16fb419c23"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Layer"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"url"</span><span class="p">:</span><span class="w"> </span><span class="s2">"http://layer.default.svc.cluster.local:6000"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"version"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
        </span><span class="s2">"endpoints"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
            </span><span class="p">{</span><span class="w">
                </span><span class="s2">"redirect"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                    </span><span class="s2">"method"</span><span class="p">:</span><span class="w"> </span><span class="s2">"GET"</span><span class="p">,</span><span class="w">
                    </span><span class="s2">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/api/v1/layer"</span><span class="w">
                </span><span class="p">},</span><span class="w">
                </span><span class="s2">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/v1/layer"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"method"</span><span class="p">:</span><span class="w"> </span><span class="s2">"GET"</span><span class="w">
            </span><span class="p">},</span><span class="w">
            </span><span class="p">{</span><span class="w">
                </span><span class="s2">"redirect"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                    </span><span class="s2">"method"</span><span class="p">:</span><span class="w"> </span><span class="s2">"POST"</span><span class="p">,</span><span class="w">
                    </span><span class="s2">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/api/v1/dataset/:dataset/layer"</span><span class="w">
                </span><span class="p">},</span><span class="w">
                </span><span class="s2">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/v1/dataset/:dataset/layer"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"method"</span><span class="p">:</span><span class="w"> </span><span class="s2">"POST"</span><span class="w">
            </span><span class="p">},</span><span class="w">
            </span><span class="p">{</span><span class="w">
                </span><span class="s2">"redirect"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                    </span><span class="s2">"method"</span><span class="p">:</span><span class="w"> </span><span class="s2">"GET"</span><span class="p">,</span><span class="w">
                    </span><span class="s2">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/api/v1/dataset/:dataset/layer"</span><span class="w">
                </span><span class="p">},</span><span class="w">
                </span><span class="s2">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/v1/dataset/:dataset/layer"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"method"</span><span class="p">:</span><span class="w"> </span><span class="s2">"GET"</span><span class="w">
            </span><span class="p">}</span><span class="w">
        </span><span class="p">],</span><span class="w">
        </span><span class="s2">"updatedAt"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2018-11-08T12:07:38.014Z"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"swagger"</span><span class="p">:</span><span class="w"> </span><span class="s2">"{}"</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">]</span><span class="w">
</span></code></pre>
<h3 id="filters">Filters</h3>

<p>The microservice list provided by the endpoint can be filtered with the following attributes:</p>

<table><thead>
<tr>
<th>Filter</th>
<th>Description</th>
<th>Accepted values</th>
</tr>
</thead><tbody>
<tr>
<td>status</td>
<td>Status of the microservice</td>
<td><code class="prettyprint">pending</code>, <code class="prettyprint">active</code> or <code class="prettyprint">error</code></td>
</tr>
<tr>
<td>url</td>
<td>Internal URL of the microservice within the cluster</td>
<td>String</td>
</tr>
</tbody></table>

<blockquote>
<p>Filtering by status</p>
</blockquote>
<pre class="highlight shell"><code>curl -X GET https://api.resourcewatch.org/api/v1/microservice?status<span class="o">=</span>active <span class="se">\</span>
-H <span class="s2">"Authorization: Bearer &lt;your-token&gt;"</span>
</code></pre>
<h2 id="get-a-microservice-by-id">Get a microservice by id</h2>

<p>To obtain the details of a single microservice, use:</p>
<pre class="highlight shell"><code>curl -X GET https://api.resourcewatch.org/api/v1/microservice/5aa667d1aee7ae16fb419c23 <span class="se">\</span>
-H <span class="s2">"Authorization: Bearer &lt;your-token&gt;"</span>
</code></pre>
<blockquote>
<p>Example response:</p>
</blockquote>
<pre class="highlight json"><code><span class="p">{</span><span class="w">
  </span><span class="s2">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="s2">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"5aa667d1aee7ae16fb419c23"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"infoStatus"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"numRetries"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
        </span><span class="s2">"error"</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w">
        </span><span class="s2">"lastCheck"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2019-02-04T14:05:30.778Z"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="s2">"pathInfo"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/info"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"pathLive"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/ping"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"status"</span><span class="p">:</span><span class="w"> </span><span class="s2">"active"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"cache"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"layer"</span><span class="w">
    </span><span class="p">],</span><span class="w">
    </span><span class="s2">"uncache"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"layer"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"dataset"</span><span class="w">
    </span><span class="p">],</span><span class="w">
    </span><span class="s2">"tags"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"layer"</span><span class="w">
    </span><span class="p">],</span><span class="w">
    </span><span class="s2">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Layer"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"url"</span><span class="p">:</span><span class="w"> </span><span class="s2">"http://layer.default.svc.cluster.local:6000"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"version"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
    </span><span class="s2">"endpoints"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="s2">"redirect"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="s2">"method"</span><span class="p">:</span><span class="w"> </span><span class="s2">"GET"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/api/v1/layer"</span><span class="w">
            </span><span class="p">},</span><span class="w">
            </span><span class="s2">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/v1/layer"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"method"</span><span class="p">:</span><span class="w"> </span><span class="s2">"GET"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="s2">"redirect"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="s2">"method"</span><span class="p">:</span><span class="w"> </span><span class="s2">"POST"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/api/v1/dataset/:dataset/layer"</span><span class="w">
            </span><span class="p">},</span><span class="w">
            </span><span class="s2">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/v1/dataset/:dataset/layer"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"method"</span><span class="p">:</span><span class="w"> </span><span class="s2">"POST"</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="s2">"redirect"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="s2">"method"</span><span class="p">:</span><span class="w"> </span><span class="s2">"GET"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/api/v1/dataset/:dataset/layer"</span><span class="w">
            </span><span class="p">},</span><span class="w">
            </span><span class="s2">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/v1/dataset/:dataset/layer"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"method"</span><span class="p">:</span><span class="w"> </span><span class="s2">"GET"</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">],</span><span class="w">
    </span><span class="s2">"updatedAt"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2018-11-08T12:07:38.014Z"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"swagger"</span><span class="p">:</span><span class="w"> </span><span class="s2">"{}"</span><span class="w">
   </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
<h2 id="delete-microservice">Delete microservice</h2>

<p>To remove a microservice:</p>
<pre class="highlight shell"><code>curl -X DELETE https://api.resourcewatch.org/api/v1/microservice/:id <span class="se">\</span>
-H <span class="s2">"Authorization: Bearer &lt;your-token&gt;"</span>
</code></pre>
<p>This will delete the microservice and its associated endpoints from the gateway&rsquo;s database. It does not remove the actual running microservice application instance, which may re-register and become available once again.</p>

      </div>
      <div class="dark-box">
          <div class="lang-selector">
                <a href="#" data-language-name="shell">cURL</a>
          </div>
      </div>
    </div>
  </body>
</html>
